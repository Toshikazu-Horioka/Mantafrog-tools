<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ãƒƒã‚­ãƒ¼åŸä¾¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #2c3e50; line-height: 1.7; font-size: 18px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-left: 4px solid #5a6c7d; }
        .header h1 { font-size: 36px; font-weight: 600; color: #2c3e50; margin-bottom: 8px; }
        .header p { color: #6c757d; font-size: 20px; }
        .section { background: white; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow: hidden; border-left: 3px solid #8b9ba8; }
        .section-header { width: 100%; padding: 20px 24px; background: #fafbfc; border: none; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 22px; font-weight: 600; color: #2c3e50; transition: all 0.2s; border-bottom: 1px solid #e9ecef; }
        .section-header:hover { background: #f1f3f5; }
        .section-content { padding: 24px; }
        .section-content.hidden { display: none; }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 18px; border: none; border-radius: 6px; font-size: 17px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #5a6c7d; color: white; } .btn-primary:hover { background: #4a5a6a; }
        .btn-green { background: #52796f; color: white; } .btn-green:hover { background: #42695f; }
        .btn-red { background: #a8625f; color: white; } .btn-red:hover { background: #98524f; }
        .btn-purple { background: #7d6b8f; color: white; } .btn-purple:hover { background: #6d5b7f; }
        .btn-orange { background: #b8956a; color: white; } .btn-orange:hover { background: #a8855a; }
        .btn-yellow { background: #c4a563; color: white; } .btn-yellow:hover { background: #b49553; }
        .btn-gray { background: #8b9ba8; color: white; } .btn-gray:hover { background: #7b8b98; }
        .btn-cyan { background: #6b8e9f; color: white; } .btn-cyan:hover { background: #5b7e8f; }
        .btn-sm { padding: 6px 12px; font-size: 15px; gap: 4px; }
        .form-input, .form-select { width: 100%; padding: 10px 14px; border: 1px solid #ced4da; border-radius: 5px; font-size: 17px; color: #495057; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #5a6c7d; }
        .form-label { display: block; font-size: 17px; font-weight: 500; color: #495057; margin-bottom: 6px; }
        .table-container { overflow-x: auto; border-radius: 6px; border: 1px solid #dee2e6; margin-bottom: 20px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #f1f3f5; font-size: 17px; }
        .table th { background: #fafbfc; font-weight: 600; font-size: 17px; color: #495057; }
        .table tr:hover { background: #f8f9fa; }
        .table tr:last-child td { border-bottom: none; }
        .table-input { width: 100%; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 16px; }
        .grid { display: grid; gap: 16px; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 8px; padding: 24px; text-align: center; border: 1px solid #e9ecef; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .stat-value { font-size: 40px; font-weight: 600; margin-bottom: 8px; color: #5a6c7d; }
        .stat-label { font-size: 16px; color: #6c757d; font-weight: 500; }
        .product-card { background: #fafbfc; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px 16px; margin-bottom: 10px; }
        .badge { display: inline-block; padding: 6px 12px; border-radius: 4px; font-size: 15px; font-weight: 500; }
        .badge-green { background: #d4e4df; color: #2d5a4c; }
        .badge-blue { background: #d6e4ed; color: #3a5569; }
        .badge-gray { background: #e9ecef; color: #6c757d; }
        .badge-orange { background: #f0e5d8; color: #7d5d3a; }
        .badge-red { background: #f0dbd9; color: #7d4542; }
        .badge-yellow { background: #f5ecd8; color: #8d7540; }
        .badge-cyan { background: #dce8ed; color: #4a6b7a; }
        .alert-box { background: #fff5f5; border: 1px solid #e8bcba; border-radius: 8px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #a8625f; }
        .alert-box h3 { color: #7d4542; font-size: 22px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .alert-item { background: white; border-left: 3px solid #a8625f; padding: 14px; margin-bottom: 8px; border-radius: 4px; font-size: 17px; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 600; }
        .font-mono { font-family: 'Courier New', monospace; }
        .text-sm { font-size: 17px; }
        .text-lg { font-size: 22px; }
        .hidden { display: none; }
        .empty-state { text-align: center; padding: 40px; color: #6c757d; font-size: 18px; }
        .text-blue { color: #5a6c7d; }
        .text-green { color: #52796f; }
        .text-red { color: #a8625f; }
        .text-purple { color: #7d6b8f; }
        .text-orange { color: #b8956a; }
        .text-gray { color: #6c757d; }
        .unit-price { background: #f0dbd9; color: #7d4542; padding: 6px 10px; border-radius: 4px; font-weight: 500; font-family: 'Courier New', monospace; font-size: 15px; }
        .expiry-warning { border-color: #a8625f !important; background: #fff5f5; }
        .expiry-caution { border-color: #c4a563 !important; background: #fffbf0; }
        .row-suspended { opacity: 0.5; background: #f8f9fa; }
        .info-box { background: #f0f5f9; border: 1px solid #c8d6e3; border-radius: 6px; padding: 16px; margin-bottom: 16px; font-size: 17px; color: #3a5569; line-height: 1.7; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; border-radius: 8px; padding: 24px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .modal-header { font-size: 24px; font-weight: 600; margin-bottom: 16px; color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 12px; }
        .modal-body { margin-bottom: 20px; color: #495057; line-height: 1.7; font-size: 17px; }
        .modal-footer { display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid #e9ecef; }
        .modal-input { width: 100%; padding: 12px 14px; border: 1px solid #ced4da; border-radius: 5px; font-size: 17px; margin-bottom: 12px; }
        .modal-input:focus { outline: none; border-color: #5a6c7d; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #52796f; color: white; padding: 16px 24px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1001; animation: slideIn 0.3s ease; font-size: 18px; }
        .toast-error { background: #a8625f; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .clickable-product { cursor: pointer; color: #5a6c7d; text-decoration: none; font-weight: 500; font-size: 18px; }
        .clickable-product:hover { color: #4a5a6a; text-decoration: underline; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .loading-overlay.show { display: flex; }
        .loading-spinner { width: 64px; height: 64px; border: 6px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .recipe-item { background: #fafbfc; border: 1px solid #e9ecef; border-radius: 6px; padding: 16px; margin-bottom: 10px; font-size: 17px; }
        .preset-card { background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 18px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; font-size: 17px; }
        .preset-card:hover { border-color: #5a6c7d; background: #f8f9fa; }
        .preset-card.selected { border-color: #5a6c7d; background: #f0f5f9; }
        .cost-display { background: #f5ecd8; border: 1px solid #d4c5a8; border-radius: 8px; padding: 20px; margin: 16px 0; text-align: center; }
        .cost-display .cost-value { font-size: 40px; font-weight: 600; color: #7d5d3a; }
        .cost-display .cost-label { font-size: 17px; color: #8d7540; margin-top: 4px; font-weight: 500; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª ã‚¯ãƒƒã‚­ãƒ¼åŸä¾¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>è£½é€ ãƒ­ãƒƒãƒˆã”ã¨ã®åŸä¾¡ç®¡ç†ã§æ­£ç¢ºãªä¾¡æ ¼äº¤æ¸‰ã‚’å®Ÿç¾</p>
        </div>

        <div id="expiry-alerts"></div>

        <div class="section">
            <button class="section-header" onclick="toggleSection('dashboard')">
                <span>ğŸ“Š åŸä¾¡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - å•†å“ä¸€è¦§</span>
                <span id="dashboard-chevron">â–¼</span>
            </button>
            <div class="section-content" id="dashboard-content">
                <div class="info-box">
                    ğŸ’¡ <strong>å•†å“åã‚’ã‚¯ãƒªãƒƒã‚¯</strong>ã—ã¦è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™<br>
                    ğŸ’¡ <strong>åŸä¾¡</strong>: å•†å“1å€‹ï¼ˆ1ç®±ï¼‰ã‚ãŸã‚Šã®è£½é€ åŸä¾¡ï¼ˆè£½å“+åŒ…æï¼‰<br>
                    ğŸ’¡ <strong>ç²—åˆ©ç‡</strong>: (è²©å£²ä¾¡æ ¼ - åŸä¾¡) / è²©å£²ä¾¡æ ¼ Ã— 100%
                </div>
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #b8956a, #9d7e5a); color: white;"><div class="stat-value" id="total-packages" style="color: white;">0</div><div class="stat-label" style="color: white;">ç™»éŒ²å•†å“æ•°</div></div>
                    <div class="stat-card"><div class="stat-value" id="total-products">0</div><div class="stat-label">ç™»éŒ²è£½å“æ•°</div></div>
                    <div class="stat-card"><div class="stat-value" id="total-materials">0</div><div class="stat-label">ææ–™ç¨®é¡æ•°</div></div>
                    <div class="stat-card"><div class="stat-value" id="active-ingredients">0</div><div class="stat-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ä»•å…¥</div></div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead><tr><th>å•†å“å</th><th>SKU</th><th>å†…å®¹</th><th class="text-right">åŸä¾¡</th><th class="text-right">è²©å£²ä¾¡æ ¼</th><th class="text-right">ç²—åˆ©ç‡</th><th class="text-center">æ“ä½œ</th></tr></thead>
                        <tbody id="dashboard-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="section">
            <button class="section-header" onclick="toggleSection('packages')">
                <span>ğŸ å•†å“ç®¡ç†ï¼ˆè©°ã‚åˆã‚ã›ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰</span>
                <span id="packages-chevron">â–¼</span>
            </button>
            <div class="section-content" id="packages-content">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="font-bold text-lg">å•†å“ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†</h3>
                        <p class="text-sm text-gray">è¤‡æ•°ã®è£½å“ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ï¼‰ã¨åŒ…æã‚’çµ„ã¿åˆã‚ã›ãŸå•†å“ã‚’ç®¡ç†</p>
                    </div>
                    <div style="display: flex; gap: 8px; flex-shrink: 0;">
                        <button class="btn btn-cyan" style="white-space: nowrap;" onclick="showPackagePresetManager()">ğŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†</button>
                        <button class="btn btn-green" style="white-space: nowrap;" onclick="showAddPackageModal()">â• å•†å“è¿½åŠ </button>
                    </div>
                </div>

                <div class="info-box" style="margin-bottom: 20px;">
                    ğŸ’¡ <strong>å•†å“</strong>: è¤‡æ•°ã®è£½å“ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ï¼‰+ åŒ…æï¼ˆç®±ãƒ»è¢‹ãªã©ï¼‰ã‚’çµ„ã¿åˆã‚ã›ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸<br>
                    ğŸ’¡ å•†å“ã®åŸä¾¡ã¯ã€å«ã¾ã‚Œã‚‹è£½å“ã¨åŒ…æã®åŸä¾¡ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™
                </div>

                <div id="packages-list">
                    <!-- å•†å“ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>

        <div class="section">
            <button class="section-header" onclick="toggleSection('products')">
                <span>ğŸª è£½å“ç®¡ç†ï¼ˆã‚¯ãƒƒã‚­ãƒ¼å˜å“ï¼‰</span>
                <span id="products-chevron">â–¼</span>
            </button>
            <div class="section-content" id="products-content">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="font-bold text-lg">è£½å“ï¼ˆã‚¯ãƒƒã‚­ãƒ¼å˜å“ï¼‰ç®¡ç†</h3>
                        <p class="text-sm text-gray">ã‚¯ãƒƒã‚­ãƒ¼1å€‹ã‚ãŸã‚Šã®ãƒ¬ã‚·ãƒ”ã¨åŸä¾¡ã‚’ç®¡ç†</p>
                    </div>
                    <button class="btn btn-green" onclick="showAddProductModal()">â• æ–°ã—ã„è£½å“ã‚’è¿½åŠ </button>
                </div>

                <div class="info-box" style="margin-bottom: 20px;">
                    ğŸ’¡ <strong>è£½å“</strong>: ã‚¯ãƒƒã‚­ãƒ¼1å€‹ã®ã“ã¨ã€‚ææ–™ã‹ã‚‰ä½œã‚‰ã‚Œã¾ã™<br>
                    ğŸ’¡ è£½å“ã®åŸä¾¡ã¯ã€ææ–™ã®ä»•å…¥ã‚Œä¾¡æ ¼ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead><tr><th>è£½å“å</th><th>SKU</th><th>ãƒ¬ã‚·ãƒ”</th><th class="text-right">1å€‹ã‚ãŸã‚ŠåŸä¾¡</th><th class="text-center">æ“ä½œ</th></tr></thead>
                        <tbody id="products-table-body"></tbody>
                    </table>
                </div>

                <div class="flex justify-between" style="margin-top: 16px;">
                    <button class="btn btn-cyan" onclick="showRecipePresetManager()">ğŸ“‹ è£½å“ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†</button>
                </div>
            </div>
        </div>

        <div class="section">
            <button class="section-header" onclick="toggleSection('materials')">
                <span>ğŸ“¦ ææ–™ãƒ»ä»•å…¥ã‚Œç®¡ç†</span>
                <span id="materials-chevron">â–¼</span>
            </button>
            <div class="section-content" id="materials-content">
                <div class="flex justify-between items-center mb-4">
                    <div><h3 class="font-bold text-lg">åŸææ–™ãƒ»åŒ…æåœ¨åº«</h3><p class="text-sm text-gray">ãƒ­ãƒƒãƒˆåˆ¥ã®ä»•å…¥ã‚Œä¾¡æ ¼ã‚’ç®¡ç†</p></div>
                    <div class="flex gap-2">
                        <button class="btn btn-purple" onclick="toggleMaterialMaster()">ğŸ“ ææ–™ãƒã‚¹ã‚¿ç·¨é›†</button>
                        <button class="btn btn-primary" onclick="addIngredient()">â• ä»•å…¥ã‚Œè¿½åŠ </button>
                    </div>
                </div>
                <div id="material-master-section" class="hidden mb-4">
                    <div class="product-card">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-purple">ææ–™ãƒã‚¹ã‚¿ç·¨é›†</h4>
                            <div class="flex gap-2">
                                <button class="btn btn-gray btn-sm" onclick="toggleSuspendedMaterials()">
                                    <span id="suspended-materials-toggle">ä¿ç•™ææ–™ã‚’è¡¨ç¤º</span>
                                </button>
                                <button class="btn btn-purple btn-sm" onclick="addMaterial()">+ ææ–™è¿½åŠ </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead><tr><th>ææ–™å</th><th>ææ–™ã‚³ãƒ¼ãƒ‰</th><th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th><th>å…·ä½“çš„ãªè£½å“å</th><th>ç¨®é¡</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th></tr></thead>
                                <tbody id="materials-master-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead><tr><th>ææ–™å</th><th>ãƒ­ãƒƒãƒˆNo</th><th>ä»•å…¥æ—¥</th><th>ä»•å…¥æ•°é‡</th><th>å˜ä½</th><th>ä»•å…¥ä¾¡æ ¼</th><th class="text-right">å˜ä¾¡</th><th>ä»•å…¥å…ˆ</th><th>è³å‘³æœŸé™</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="ingredients-table"></tbody>
                    </table>
                </div>
                <div id="no-ingredients" class="empty-state hidden">
                    <div style="font-size: 48px; margin-bottom: 16px; color: #d1d5db;">ğŸ“‹</div>
                    <p>ä»•å…¥ã‚Œãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    <p class="text-sm">ã€Œä»•å…¥ã‚Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ææ–™ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                </div>

                <div class="mb-4">
                    <button class="btn btn-yellow btn-sm" onclick="toggleUsedUpSection()">
                        <span id="used-up-toggle-text">ğŸ“œ ä½¿ã„åˆ‡ã‚Šå±¥æ­´ã‚’è¡¨ç¤º</span>
                    </button>
                </div>
                <div id="used-up-section" class="hidden">
                    <div class="product-card">
                        <h4 class="font-bold mb-4">ä½¿ã„åˆ‡ã‚Šå±¥æ­´</h4>
                        <div class="table-container">
                            <table class="table">
                                <thead><tr><th>ææ–™å</th><th>ãƒ­ãƒƒãƒˆNo</th><th>ä»•å…¥æ—¥</th><th>ä»•å…¥æ•°é‡</th><th>å˜ä½</th><th>ä»•å…¥ä¾¡æ ¼</th><th>ä»•å…¥å…ˆ</th><th>ä½¿ã„åˆ‡ã‚Šæ—¥</th><th>æ“ä½œ</th></tr></thead>
                                <tbody id="used-up-table"></tbody>
                            </table>
                        </div>
                        <div id="no-used-up" class="empty-state hidden">
                            <p class="text-sm text-gray">ä½¿ã„åˆ‡ã‚Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>

                <div class="product-card">
                    <h4 class="font-bold mb-4">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
                    <div class="grid grid-2">
                        <div><button class="btn btn-green" onclick="saveDataToCloud()">â˜ï¸ ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button><p class="text-sm text-gray" style="margin-top: 8px;">ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</p></div>
                        <div><input type="file" id="import-file" accept=".json" style="display: none;"><button class="btn btn-primary" onclick="document.getElementById('import-file').click()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button><p class="text-sm text-gray" style="margin-top: 8px;">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</p></div>
                        <div><button class="btn btn-gray" onclick="loadLatestFromCloud()">â˜ï¸ æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—</button><p class="text-sm text-gray" style="margin-top: 8px;">ä¿å­˜æ¸ˆã¿æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // S3ç½²åä»˜ãURLã‚’ç™ºè¡Œã™ã‚‹API Gatewayã®ãƒ™ãƒ¼ã‚¹URLï¼ˆCDKãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«ç½®ãæ›ãˆï¼‰
        const API_BASE = 'https://vvxdlcle1f.execute-api.ap-northeast-1.amazonaws.com';
        // ã“ã®ãƒ„ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿æ ¼ç´ç”¨ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
        const TOOL_ID = 'cost-calculation';

        let products = [];
        let materials = [];
        let ingredients = [];
        let usedUpIngredients = [];
        let recipePresets = [];
        let packages = [];  // å•†å“ï¼ˆè©°ã‚åˆã‚ã›ï¼‰ãƒ‡ãƒ¼ã‚¿
        let packagePresets = [];  // â˜…è¿½åŠ : å•†å“ãƒ—ãƒªã‚»ãƒƒãƒˆ
        let sections = { dashboard: true, products: true, packages: true, materials: true };  // â˜…productsè¿½åŠ 
        let showUsedUp = false;
        let showSuspendedMaterials = false;

        const fmt = (v) => `Â¥${Math.ceil(v || 0).toLocaleString()}`;
        const fmtDec = (v) => `Â¥${(v || 0).toFixed(2)}`;
        const genId = () => `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const esc = (t) => { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };
        
        const genLot = (code) => {
            if (!code) return '';
            const allIngredients = [...ingredients, ...usedUpIngredients];
            const ex = allIngredients.filter(i => i.material_code === code).map(i => i.lot_no).filter(l => l && l.startsWith(code)).map(l => parseInt(l.replace(code, '')) || 0).sort((a, b) => b - a);
            return `${code}${String((ex[0] || 0) + 1).padStart(3, '0')}`;
        };

        const genPackageSku = (baseSku) => {
            if (!baseSku) return '';
            // æ—¢å­˜ã®å•†å“ã‹ã‚‰åŒã˜ãƒ™ãƒ¼ã‚¹SKUã‚’æŒã¤ã‚‚ã®ã‚’æ¤œç´¢
            const existingSkus = packages
                .map(p => p.sku)
                .filter(sku => sku && sku.startsWith(baseSku))
                .map(sku => {
                    // æœ«å°¾ã®æ•°å­—ã‚’æŠ½å‡º
                    const match = sku.match(/-(\d+)$/);
                    return match ? parseInt(match[1]) : 0;
                })
                .sort((a, b) => b - a);
            
            const nextNum = (existingSkus[0] || 0) + 1;
            return `${baseSku}-${String(nextNum).padStart(3, '0')}`;
        };

        function calculateProductCost(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || !product.recipe || product.recipe.length === 0) return 0;
            
            let totalCost = 0;
            product.recipe.forEach(recipeItem => {
                const material = materials.find(m => m.id === recipeItem.material_id);
                if (!material) return;
                
                // â˜…ä¿®æ­£: ä½¿ã„åˆ‡ã‚Šãƒ­ãƒƒãƒˆã‚‚å«ã‚ã¦æ¤œç´¢
                let selectedIngredient = null;
                if (recipeItem.ingredient_id) {
                    // ã¾ãšã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ­ãƒƒãƒˆã‹ã‚‰æ¢ã™
                    selectedIngredient = ingredients.find(i => i.id === recipeItem.ingredient_id);
                    // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ä½¿ã„åˆ‡ã‚Šãƒ­ãƒƒãƒˆã‹ã‚‰ã‚‚æ¢ã™
                    if (!selectedIngredient) {
                        selectedIngredient = usedUpIngredients.find(i => i.id === recipeItem.ingredient_id);
                    }
                }
                
                if (!selectedIngredient) {
                    // ã¾ãšã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ­ãƒƒãƒˆã‹ã‚‰æœ€æ–°ã‚’å–å¾—
                    const activeIngredients = ingredients.filter(i => i.material_id === recipeItem.material_id && i.qty > 0);
                    if (activeIngredients.length > 0) {
                        selectedIngredient = activeIngredients.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    } else {
                        // â˜…ä¿®æ­£: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ­ãƒƒãƒˆãŒãªã„å ´åˆã¯ä½¿ã„åˆ‡ã‚Šãƒ­ãƒƒãƒˆã‹ã‚‰æœ€æ–°ã‚’å–å¾—
                        const usedUpForMaterial = usedUpIngredients.filter(i => i.material_id === recipeItem.material_id);
                        if (usedUpForMaterial.length > 0) {
                            selectedIngredient = usedUpForMaterial.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                        }
                    }
                }
                
                if (selectedIngredient) {
                    const unitPrice = selectedIngredient.price / selectedIngredient.qty;
                    totalCost += unitPrice * recipeItem.quantity;
                }
            });
            
            return totalCost;
        }

        function showToast(message, isError = false) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'toast-error' : ''}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showConfirm(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">${esc(title)}</div>
                    <div class="modal-body" style="white-space: pre-line;">${esc(message)}</div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="btn btn-red" id="confirm-btn">å®Ÿè¡Œ</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            document.getElementById('confirm-btn').onclick = () => {
                modal.remove();
                onConfirm();
            };
        }

        function initData() {
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ã¯ç©ºã§é–‹å§‹
            products = [];
            materials = [];
            ingredients = [];
            usedUpIngredients = [];
            recipePresets = [];
            packages = [];
            packagePresets = [];
        }

        function showRecipeEditor(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (!product.recipe) product.recipe = [];
            if (!product.pricing) product.pricing = { sellingPrice: 0, targetMargin: 0 };
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 1000px;">
                    <div class="modal-header">ğŸ“ ãƒ¬ã‚·ãƒ”ç·¨é›†: ${esc(product.name)}</div>
                    <div class="modal-body">
                        <div class="info-box" style="margin-bottom: 16px;">
                            ğŸ’¡ <strong>ä½¿ç”¨ãƒ­ãƒƒãƒˆ</strong>ã‚’é¸æŠã—ã¦ã€1å€‹ã‚ãŸã‚Šã®<strong>ä½¿ç”¨é‡</strong>ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„<br>
                            ğŸ’¡ åŸä¾¡ã¯é¸æŠã—ãŸãƒ­ãƒƒãƒˆã®ä»•å…¥ã‚Œä¾¡æ ¼ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <button class="btn btn-cyan btn-sm" onclick="showPresetSelector('${productId}')">ğŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰ææ–™ã‚’é¸æŠ</button>
                        </div>
                        
                        <!-- ææ–™è©³ç´°ãƒˆã‚°ãƒ« -->
                        <div class="product-card" style="margin-bottom: 20px;">
                            <button class="section-header" style="width: 100%; background: transparent; border: none; padding: 12px 0;" onclick="toggleRecipeMaterials('${productId}')">
                                <span style="font-size: 16px; font-weight: 600;">ğŸ“¦ ææ–™è©³ç´°</span>
                                <span id="recipe-materials-chevron-${productId}">â–¼</span>
                            </button>
                            <div id="recipe-materials-content-${productId}" style="margin-top: 12px;">
                                <div id="recipe-list-${productId}"></div>
                                <button class="btn btn-primary btn-sm" onclick="addRecipeItem('${productId}')" style="margin-top: 12px;">+ ææ–™ã‚’è¿½åŠ </button>
                            </div>
                        </div>
                        
                        <!-- åŸä¾¡è¡¨ç¤º -->
                        <div class="cost-display" id="cost-display-${productId}">
                            <div class="cost-value">Â¥0.00</div>
                            <div class="cost-label">1å€‹ã‚ãŸã‚Šã®åŸä¾¡ï¼ˆé¸æŠãƒ­ãƒƒãƒˆåŸºæº–ï¼‰</div>
                        </div>
                        
                        <!-- åç›Šè¨ˆç®—ãƒˆã‚°ãƒ« -->
                        <div class="product-card" style="margin-top: 20px; border: 2px solid #52796f;">
                            <button class="section-header" style="width: 100%; background: transparent; border: none; padding: 12px 0;" onclick="togglePricingSection('${productId}')">
                                <span style="font-size: 16px; font-weight: 600; color: #52796f;">ğŸ’° åç›Šè¨ˆç®—</span>
                                <span id="pricing-section-chevron-${productId}">â–¼</span>
                            </button>
                            <div id="pricing-section-content-${productId}" style="margin-top: 12px;">
                                <div class="grid grid-2" style="gap: 20px;">
                                    <div>
                                        <label class="form-label">è²©å£²ä¾¡æ ¼ã‚’è¨­å®š</label>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-weight: 600;">Â¥</span>
                                            <input type="number" class="form-input" id="selling-price-${productId}" 
                                                value="${product.pricing.sellingPrice || ''}" 
                                                min="0" step="1" placeholder="ä¾‹: 300"
                                                onchange="updateSellingPrice('${productId}', this.value)">
                                        </div>
                                        <div id="margin-display-${productId}" style="margin-top: 12px; padding: 12px; background: #d4e4df; border-radius: 6px; display: none;">
                                            <div style="font-size: 13px; color: #2d5a4c; margin-bottom: 4px;">ç²—åˆ©ç‡</div>
                                            <div style="font-size: 24px; font-weight: 600; color: #2d5a4c;">0%</div>
                                            <div style="font-size: 12px; color: #52796f; margin-top: 4px;">ç²—åˆ©é¡: Â¥0</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label">ç›®æ¨™ç²—åˆ©ç‡ã‚’è¨­å®š</label>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="number" class="form-input" id="target-margin-${productId}" 
                                                value="${product.pricing.targetMargin || ''}" 
                                                min="0" max="100" step="0.1" placeholder="ä¾‹: 40"
                                                onchange="updateTargetMargin('${productId}', this.value)">
                                            <span style="font-weight: 600;">%</span>
                                        </div>
                                        <div id="min-price-display-${productId}" style="margin-top: 12px; padding: 12px; background: #f5ecd8; border-radius: 6px; display: none;">
                                            <div style="font-size: 13px; color: #7d5d3a; margin-bottom: 4px;">æœ€ä½è²©å£²ä¾¡æ ¼</div>
                                            <div style="font-size: 24px; font-weight: 600; color: #7d5d3a;">Â¥0</div>
                                            <div style="font-size: 12px; color: #8d7540; margin-top: 4px;">ç›®æ¨™ç²—åˆ©é¡: Â¥0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="info-box" style="margin-top: 16px;">
                                    ğŸ’¡ <strong>ç²—åˆ©ç‡</strong> = (è²©å£²ä¾¡æ ¼ - åŸä¾¡) Ã· è²©å£²ä¾¡æ ¼ Ã— 100<br>
                                    ğŸ’¡ <strong>æœ€ä½è²©å£²ä¾¡æ ¼</strong> = åŸä¾¡ Ã· (1 - ç›®æ¨™ç²—åˆ©ç‡)
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="btn btn-green" onclick="saveRecipe('${productId}')">ä¿å­˜</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            renderRecipeList(productId);
            updateCostDisplay(productId);
            updatePricingDisplays(productId);
        }

        function toggleRecipeMaterials(productId) {
            const content = document.getElementById(`recipe-materials-content-${productId}`);
            const chevron = document.getElementById(`recipe-materials-chevron-${productId}`);
            if (content && chevron) {
                const isHidden = content.style.display === 'none';
                content.style.display = isHidden ? 'block' : 'none';
                chevron.textContent = isHidden ? 'â–¼' : 'â–¶';
            }
        }

        function togglePricingSection(productId) {
            const content = document.getElementById(`pricing-section-content-${productId}`);
            const chevron = document.getElementById(`pricing-section-chevron-${productId}`);
            if (content && chevron) {
                const isHidden = content.style.display === 'none';
                content.style.display = isHidden ? 'block' : 'none';
                chevron.textContent = isHidden ? 'â–¼' : 'â–¶';
            }
        }

        function updateSellingPrice(productId, value) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (!product.pricing) product.pricing = { sellingPrice: 0, targetMargin: 0 };
            product.pricing.sellingPrice = parseFloat(value) || 0;
            
            updatePricingDisplays(productId);
        }

        function updateTargetMargin(productId, value) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (!product.pricing) product.pricing = { sellingPrice: 0, targetMargin: 0 };
            product.pricing.targetMargin = parseFloat(value) || 0;
            
            updatePricingDisplays(productId);
        }

        function updatePricingDisplays(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || !product.pricing) return;
            
            const cost = calculateProductCost(productId);
            const sellingPrice = product.pricing.sellingPrice || 0;
            const targetMargin = product.pricing.targetMargin || 0;
            
            // è²©å£²ä¾¡æ ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼šç²—åˆ©ç‡ã‚’è¨ˆç®—
            const marginDisplay = document.getElementById(`margin-display-${productId}`);
            if (marginDisplay) {
                if (sellingPrice > 0) {
                    const grossProfit = sellingPrice - cost;
                    const marginRate = (grossProfit / sellingPrice * 100).toFixed(1);
                    marginDisplay.style.display = 'block';
                    const marginRateEl = marginDisplay.querySelector('div:nth-child(2)');
                    const grossProfitEl = marginDisplay.querySelector('div:nth-child(3)');
                    if (marginRateEl) marginRateEl.textContent = `${marginRate}%`;
                    if (grossProfitEl) grossProfitEl.textContent = `ç²—åˆ©é¡: ${fmt(grossProfit)}`;
                } else {
                    marginDisplay.style.display = 'none';
                }
            }
            
            // ç›®æ¨™ç²—åˆ©ç‡ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼šæœ€ä½è²©å£²ä¾¡æ ¼ã‚’è¨ˆç®—
            const minPriceDisplay = document.getElementById(`min-price-display-${productId}`);
            if (minPriceDisplay) {
                if (targetMargin > 0 && targetMargin < 100) {
                    const minPrice = cost / (1 - targetMargin / 100);
                    const targetProfit = minPrice - cost;
                    minPriceDisplay.style.display = 'block';
                    const minPriceEl = minPriceDisplay.querySelector('div:nth-child(2)');
                    const targetProfitEl = minPriceDisplay.querySelector('div:nth-child(3)');
                    if (minPriceEl) minPriceEl.textContent = fmt(minPrice);
                    if (targetProfitEl) targetProfitEl.textContent = `ç›®æ¨™ç²—åˆ©é¡: ${fmt(targetProfit)}`;
                } else {
                    minPriceDisplay.style.display = 'none';
                }
            }
        }

        function renderRecipeList(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const container = document.getElementById(`recipe-list-${productId}`);
            if (!container) return;
            
            if (!product.recipe || product.recipe.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><p class="text-sm text-gray">ææ–™ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
                return;
            }
            
            container.innerHTML = '';
            product.recipe.forEach((item, index) => {
                const material = materials.find(m => m.id === item.material_id);
                if (!material) return;
                
                const activeIngredients = ingredients.filter(i => i.material_id === item.material_id && i.qty > 0);
                
                // é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ­ãƒƒãƒˆã€ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€æ–°ã®ãƒ­ãƒƒãƒˆ
                let selectedIngredient = null;
                if (item.ingredient_id) {
                    selectedIngredient = ingredients.find(i => i.id === item.ingredient_id);
                }
                if (!selectedIngredient && activeIngredients.length > 0) {
                    selectedIngredient = activeIngredients.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠã‚’ãƒ¬ã‚·ãƒ”ã«ä¿å­˜
                    if (selectedIngredient) {
                        item.ingredient_id = selectedIngredient.id;
                    }
                }
                
                let unitPrice = 0;
                let unitText = 'g';
                let lotOptions = '';
                
                if (activeIngredients.length === 0) {
                    lotOptions = '<option value="">åœ¨åº«ãªã—</option>';
                } else {
                    activeIngredients.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(ing => {
                        const ingUnitPrice = ing.price / ing.qty;
                        const selected = item.ingredient_id === ing.id ? 'selected' : '';
                        lotOptions += `<option value="${ing.id}" ${selected}>${esc(ing.lot_no)} (${fmtDec(ingUnitPrice)}/${ing.unit}, åœ¨åº«:${ing.qty}${ing.unit})</option>`;
                    });
                }
                
                if (selectedIngredient) {
                    unitPrice = selectedIngredient.price / selectedIngredient.qty;
                    unitText = selectedIngredient.unit;
                }
                
                const itemCost = unitPrice * item.quantity;
                
                const div = document.createElement('div');
                div.className = 'recipe-item';
                div.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <strong>${esc(material.name)}</strong>
                        <span class="badge badge-blue" style="margin-left: 8px;">${esc(material.code)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div style="flex: 1; margin-right: 12px;">
                            <label class="text-sm text-gray" style="display: block; margin-bottom: 4px;">ä½¿ç”¨ãƒ­ãƒƒãƒˆé¸æŠ</label>
                            <select class="table-input" onchange="updateRecipeLot('${productId}', ${index}, this.value)" style="width: 100%;">
                                ${lotOptions}
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div>
                                <label class="text-sm text-gray" style="display: block; margin-bottom: 4px;">ä½¿ç”¨é‡</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" class="table-input" style="width: 100px;" 
                                        value="${item.quantity}" min="0" step="0.1"
                                        onchange="updateRecipeQuantity('${productId}', ${index}, this.value)"
                                        placeholder="æ•°é‡">
                                    <span style="width: 40px;">${unitText}</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <label class="text-sm text-gray" style="display: block; margin-bottom: 4px;">å°è¨ˆ</label>
                                <span style="font-weight: 600; color: #7d5d3a; font-size: 16px;">${fmtDec(itemCost)}</span>
                            </div>
                            <button class="btn btn-red btn-sm" onclick="removeRecipeItem('${productId}', ${index})" style="align-self: flex-end;">å‰Šé™¤</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addRecipeItem(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (!product.recipe) product.recipe = [];
            
            const activeMaterials = materials.filter(m => m.status === 'active');
            if (activeMaterials.length === 0) {
                showToast('ææ–™ãƒã‚¹ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“', true);
                return;
            }
            
            product.recipe.push({ material_id: activeMaterials[0].id, quantity: 0, ingredient_id: null });
            renderRecipeList(productId);
            updateCostDisplay(productId);
        }

        function updateRecipeQuantity(productId, index, value) {
            const product = products.find(p => p.id === productId);
            if (!product || !product.recipe[index]) return;
            
            product.recipe[index].quantity = parseFloat(value) || 0;
            updateCostDisplay(productId);
            updatePricingDisplays(productId);
        }

        function updateRecipeLot(productId, index, ingredientId) {
            const product = products.find(p => p.id === productId);
            if (!product || !product.recipe[index]) return;
            
            product.recipe[index].ingredient_id = ingredientId;
            renderRecipeList(productId);
            updateCostDisplay(productId);
            updatePricingDisplays(productId);
        }

        function removeRecipeItem(productId, index) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            product.recipe.splice(index, 1);
            renderRecipeList(productId);
            updateCostDisplay(productId);
        }

        function updateCostDisplay(productId) {
            const cost = calculateProductCost(productId);
            const display = document.getElementById(`cost-display-${productId}`);
            if (display) {
                const costValueEl = display.querySelector('.cost-value');
                if (costValueEl) {
                    costValueEl.textContent = fmtDec(cost);
                }
            }
        }

        function saveRecipe(productId) {
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();
            renderAll();
            showToast('ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function showPresetSelector(productId) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">ğŸ“‹ ãƒ¬ã‚·ãƒ”ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ</div>
                    <div class="modal-body">
                        <div class="info-box" style="margin-bottom: 16px;">
                            ğŸ’¡ ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠã™ã‚‹ã¨ã€ç¾åœ¨ã®ãƒ¬ã‚·ãƒ”ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™
                        </div>
                        <div id="preset-list"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            const presetList = document.getElementById('preset-list');
            if (recipePresets.length === 0) {
                presetList.innerHTML = '<div class="empty-state"><p class="text-sm text-gray">ãƒ—ãƒªã‚»ãƒƒãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
                return;
            }
            
            recipePresets.forEach(preset => {
                const div = document.createElement('div');
                div.className = 'preset-card';
                div.onclick = () => {
                    applyPreset(productId, preset.id);
                    modal.remove();
                };
                
                let ingredientsList = '';
                preset.recipe.forEach(item => {
                    const material = materials.find(m => m.id === item.material_id);
                    if (material) {
                        ingredientsList += `<div class="text-sm text-gray">â€¢ ${esc(material.name)}: ${item.quantity}g</div>`;
                    }
                });
                
                div.innerHTML = `
                    <div class="font-bold" style="margin-bottom: 8px;">${esc(preset.name)}</div>
                    ${ingredientsList}
                `;
                presetList.appendChild(div);
            });
        }

        function applyPreset(productId, presetId) {
            const product = products.find(p => p.id === productId);
            const preset = recipePresets.find(pr => pr.id === presetId);
            if (!product || !preset) return;
            
            // â˜…ä¿®æ­£: ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰SKU(è£½å“ã‚³ãƒ¼ãƒ‰)ã‚‚è‡ªå‹•è¨­å®š
            if (preset.sku && !product.sku) {
                product.sku = preset.sku;
            }
            
            product.recipe = JSON.parse(JSON.stringify(preset.recipe));
            renderRecipeList(productId);
            updateCostDisplay(productId);
            showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸ');
        }

        function showRecipePresetManager() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">ğŸ“‹ ãƒ¬ã‚·ãƒ”ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†</div>
                    <div class="modal-body">
                        <div class="info-box" style="margin-bottom: 16px;">
                            ğŸ’¡ ã‚ˆãä½¿ã†ãƒ¬ã‚·ãƒ”ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆã¨ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚æ–°è£½å“è¿½åŠ æ™‚ã«ç´ æ—©ãè¨­å®šå¯èƒ½ã§ã™ã€‚
                        </div>
                        <button class="btn btn-green btn-sm" onclick="showAddPresetModal()" style="margin-bottom: 16px;">+ ãƒ—ãƒªã‚»ãƒƒãƒˆè¿½åŠ </button>
                        <div id="preset-manager-list"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            renderPresetManagerList();
        }

        function renderPresetManagerList() {
            const container = document.getElementById('preset-manager-list');
            if (!container) return;
            
            if (recipePresets.length === 0) {
                container.innerHTML = '<div class="empty-state"><p class="text-sm text-gray">ãƒ—ãƒªã‚»ãƒƒãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
                return;
            }
            
            container.innerHTML = '';
            recipePresets.forEach(preset => {
                const div = document.createElement('div');
                div.className = 'product-card';
                
                let ingredientsList = '';
                preset.recipe.forEach(item => {
                    const material = materials.find(m => m.id === item.material_id);
                    if (material) {
                        ingredientsList += `<div class="text-sm text-gray">â€¢ ${esc(material.name)}: ${item.quantity}g</div>`;
                    }
                });
                
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold" style="margin-bottom: 8px;">${esc(preset.name)}</div>
                            ${ingredientsList}
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-primary btn-sm" onclick="showEditPresetModal('${preset.id}')">ç·¨é›†</button>
                            <button class="btn btn-red btn-sm" onclick="deletePreset('${preset.id}')">å‰Šé™¤</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function showAddPresetModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">æ–°è¦ãƒ—ãƒªã‚»ãƒƒãƒˆä½œæˆ</div>
                    <div class="modal-body">
                        <label class="form-label">ãƒ—ãƒªã‚»ãƒƒãƒˆå</label>
                        <input type="text" class="modal-input" id="preset-name" placeholder="ä¾‹: ãƒãƒ§ã‚³ãƒãƒƒãƒ—ã‚¯ãƒƒã‚­ãƒ¼ï¼ˆåŸºæœ¬ï¼‰">
                        
                        <label class="form-label">æ—¢å­˜è£½å“ã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                        <select class="form-select" id="copy-from-product">
                            <option value="">æ–°è¦ä½œæˆ</option>
                            ${products.filter(p => p.recipe && p.recipe.length > 0).map(p => 
                                `<option value="${p.id}">${esc(p.name)}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="btn btn-green" onclick="createPreset()">ä½œæˆ</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            document.getElementById('preset-name').focus();
        }

        function createPreset() {
            const name = document.getElementById('preset-name').value.trim();
            const copyFromId = document.getElementById('copy-from-product').value;
            
            if (!name) {
                showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            let recipe = [];
            if (copyFromId) {
                const product = products.find(p => p.id === copyFromId);
                if (product && product.recipe) {
                    recipe = JSON.parse(JSON.stringify(product.recipe));
                }
            }
            
            recipePresets.push({
                id: genId(),
                name: name,
                recipe: recipe
            });
            
            document.querySelector('.modal-overlay').remove();
            showRecipePresetManager();
            showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
        }

        function showEditPresetModal(presetId) {
            const preset = recipePresets.find(p => p.id === presetId);
            if (!preset) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">ãƒ—ãƒªã‚»ãƒƒãƒˆç·¨é›†</div>
                    <div class="modal-body">
                        <label class="form-label">ãƒ—ãƒªã‚»ãƒƒãƒˆå</label>
                        <input type="text" class="modal-input" id="edit-preset-name" value="${esc(preset.name)}">
                        
                        <label class="form-label" style="margin-top: 16px;">ãƒ¬ã‚·ãƒ”</label>
                        <div id="edit-preset-recipe-list"></div>
                        <button class="btn btn-primary btn-sm" onclick="addPresetRecipeItem('${presetId}')" style="margin-top: 8px;">+ ææ–™ã‚’è¿½åŠ </button>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="btn btn-green" onclick="savePresetEdit('${presetId}')">ä¿å­˜</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            document.getElementById('edit-preset-name').focus();
            renderEditPresetRecipeList(presetId);
        }

        function renderEditPresetRecipeList(presetId) {
            const preset = recipePresets.find(p => p.id === presetId);
            if (!preset) return;
            
            const container = document.getElementById('edit-preset-recipe-list');
            if (!container) return;
            
            if (!preset.recipe || preset.recipe.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><p class="text-sm text-gray">ææ–™ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
                return;
            }
            
            container.innerHTML = '';
            const activeMaterials = materials.filter(m => m.status === 'active');
            
            preset.recipe.forEach((item, index) => {
                const material = materials.find(m => m.id === item.material_id);
                
                const div = document.createElement('div');
                div.className = 'recipe-item';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <select class="table-input" style="flex: 1; margin-right: 12px;" onchange="updatePresetRecipeMaterial('${presetId}', ${index}, this.value)">
                            ${activeMaterials.map(mat => 
                                `<option value="${mat.id}" ${mat.id === item.material_id ? 'selected' : ''}>${esc(mat.name)}</option>`
                            ).join('')}
                        </select>
                        <input type="number" class="table-input" style="width: 100px;" 
                            value="${item.quantity}" min="0" step="0.1"
                            onchange="updatePresetRecipeQuantity('${presetId}', ${index}, this.value)"
                            placeholder="æ•°é‡">
                        <span style="width: 40px; margin-left: 8px;">g</span>
                        <button class="btn btn-red btn-sm" onclick="removePresetRecipeItem('${presetId}', ${index})" style="margin-left: 12px;">å‰Šé™¤</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addPresetRecipeItem(presetId) {
            const preset = recipePresets.find(p => p.id === presetId);
            if (!preset) return;
            
            if (!preset.recipe) preset.recipe = [];
            
            const activeMaterials = materials.filter(m => m.status === 'active');
            if (activeMaterials.length === 0) {
                showToast('ææ–™ãƒã‚¹ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“', true);
                return;
            }
            
            preset.recipe.push({ material_id: activeMaterials[0].id, quantity: 0 });
            renderEditPresetRecipeList(presetId);
        }

        function updatePresetRecipeMaterial(presetId, index, materialId) {
            const preset = recipePresets.find(p => p.id === presetId);
            if (!preset || !preset.recipe[index]) return;
            
            preset.recipe[index].material_id = materialId;
            renderEditPresetRecipeList(presetId);
        }

        function updatePresetRecipeQuantity(presetId, index, value) {
            const preset = recipePresets.find(p => p.id === presetId);
            if (!preset || !preset.recipe[index]) return;
            
            preset.recipe[index].quantity = parseFloat(value) || 0;
        }

        function removePresetRecipeItem(presetId, index) {
            const preset = recipePresets.find(p => p.id === presetId);
            if (!preset) return;
            
            preset.recipe.splice(index, 1);
            renderEditPresetRecipeList(presetId);
        }

        function savePresetEdit(presetId) {
            const preset = recipePresets.find(p => p.id === presetId);
            if (!preset) return;
            
            const newName = document.getElementById('edit-preset-name').value.trim();
            if (!newName) {
                showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            preset.name = newName;
            
            document.querySelector('.modal-overlay').remove();
            showRecipePresetManager();
            showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        }

        function deletePreset(presetId) {
            const preset = recipePresets.find(p => p.id === presetId);
            if (!preset) return;
            
            showConfirm('ãƒ—ãƒªã‚»ãƒƒãƒˆå‰Šé™¤', `ã€Œ${preset.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, () => {
                recipePresets = recipePresets.filter(p => p.id !== presetId);
                renderPresetManagerList();
                showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            });
        }

        function checkExpiryAlerts() {
            const alertsDiv = document.getElementById('expiry-alerts');
            if (!alertsDiv) return;
            
            const today = new Date();
            const warningDate = new Date(today);
            warningDate.setDate(warningDate.getDate() + 30);
            const cautionDate = new Date(today);
            cautionDate.setDate(cautionDate.getDate() + 60);
            
            const alerts = [];
            
            ingredients.forEach(ing => {
                if (!ing.expiry) return;
                const expiry = new Date(ing.expiry);
                const mat = materials.find(m => m.id === ing.material_id);
                if (!mat) return;
                
                if (expiry < today) {
                    alerts.push({ level: 'expired', ingredient: ing, material: mat, days: Math.floor((today - expiry) / (1000 * 60 * 60 * 24)) });
                } else if (expiry <= warningDate) {
                    alerts.push({ level: 'warning', ingredient: ing, material: mat, days: Math.floor((expiry - today) / (1000 * 60 * 60 * 24)) });
                } else if (expiry <= cautionDate) {
                    alerts.push({ level: 'caution', ingredient: ing, material: mat, days: Math.floor((expiry - today) / (1000 * 60 * 60 * 24)) });
                }
            });
            
            if (alerts.length === 0) {
                alertsDiv.innerHTML = '';
                return;
            }
            
            alerts.sort((a, b) => a.days - b.days);
            
            let html = '<div class="alert-box"><h3>âš ï¸ è³å‘³æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆ</h3>';
            alerts.forEach(alert => {
                let message = '';
                let badgeClass = '';
                if (alert.level === 'expired') {
                    message = `æœŸé™åˆ‡ã‚Œ(${alert.days}æ—¥è¶…é)`;
                    badgeClass = 'badge-red';
                } else if (alert.level === 'warning') {
                    message = `æœŸé™ã¾ã§ã‚ã¨${alert.days}æ—¥`;
                    badgeClass = 'badge-red';
                } else {
                    message = `æœŸé™ã¾ã§ã‚ã¨${alert.days}æ—¥`;
                    badgeClass = 'badge-yellow';
                }
                html += `<div class="alert-item">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="badge ${badgeClass}">${message}</span>
                            <strong>${esc(alert.material.name)}</strong> (ãƒ­ãƒƒãƒˆ: ${esc(alert.ingredient.lot_no)})
                            - è³å‘³æœŸé™: ${alert.ingredient.expiry}
                        </div>
                        <button class="btn btn-red btn-sm" onclick="markAsUsedUp('${alert.ingredient.id}')">ä½¿ã„åˆ‡ã‚Šã«ã™ã‚‹</button>
                    </div>
                </div>`;
            });
            html += '</div>';
            alertsDiv.innerHTML = html;
        }

        function toggleSection(name) {
            const c = document.getElementById(`${name}-content`);
            const ch = document.getElementById(`${name}-chevron`);
            if (!c || !ch) return;
            sections[name] = !sections[name];
            c.classList.toggle('hidden', !sections[name]);
            ch.textContent = sections[name] ? 'â–¼' : 'â–¶';
        }

        function showAddProductModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">æ–°è£½å“è¿½åŠ </div>
                    <div class="modal-body">
                        <label class="form-label">è£½å“å</label>
                        <input type="text" class="modal-input" id="product-name" placeholder="ä¾‹: ãƒãƒ§ã‚³ãƒãƒƒãƒ—ã‚¯ãƒƒã‚­ãƒ¼">
                        <label class="form-label">è£½å“ã‚³ãƒ¼ãƒ‰ (SKU)</label>
                        <input type="text" class="modal-input" id="product-sku" placeholder="ä¾‹: CK-CHOCO-001">
                        
                        <label class="form-label">ãƒ¬ã‚·ãƒ”ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                        <select class="form-select" id="product-preset">
                            <option value="">å¾Œã§è¨­å®š</option>
                            ${recipePresets.map(preset => 
                                `<option value="${preset.id}">${esc(preset.name)}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="btn btn-green" id="add-product-btn">è¿½åŠ </button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            const nameInput = document.getElementById('product-name');
            if (nameInput) nameInput.focus();
            
            // â˜…è¿½åŠ : ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠæ™‚ã«è£½å“åã¨SKUã‚’è‡ªå‹•å…¥åŠ›
            const presetSelect = document.getElementById('product-preset');
            if (presetSelect) {
                presetSelect.addEventListener('change', function() {
                    const presetId = this.value;
                    if (presetId) {
                        const preset = recipePresets.find(p => p.id === presetId);
                        if (preset) {
                            // è£½å“åã‚’è‡ªå‹•å…¥åŠ›
                            const nameInput = document.getElementById('product-name');
                            if (nameInput && !nameInput.value) {
                                nameInput.value = preset.name.replace(/ï¼ˆåŸºæœ¬ï¼‰$/, '').trim();
                            }
                            
                            // SKUã‚’è‡ªå‹•æ¡ç•ª
                            if (preset.sku) {
                                const skuInput = document.getElementById('product-sku');
                                if (skuInput) {
                                    // ãƒ—ãƒªã‚»ãƒƒãƒˆã®SKUã‹ã‚‰åŸºæœ¬éƒ¨åˆ†ã‚’å–å¾— (ä¾‹: CK-CHOCO-001 â†’ CK-CHOCO-)
                                    const baseSku = preset.sku.replace(/-\d+$/, '');
                                    
                                    // åŒã˜åŸºæœ¬SKUã‚’æŒã¤è£½å“ã‚’æ¤œç´¢
                                    const existingProducts = products.filter(p => 
                                        p.sku && p.sku.startsWith(baseSku)
                                    );
                                    
                                    // æœ€å¤§ã®ç•ªå·ã‚’å–å¾—
                                    let maxNumber = 0;
                                    existingProducts.forEach(p => {
                                        const match = p.sku.match(/-(\d+)$/);
                                        if (match) {
                                            const num = parseInt(match[1]);
                                            if (num > maxNumber) maxNumber = num;
                                        }
                                    });
                                    
                                    // æ¬¡ã®ç•ªå·ã‚’ç”Ÿæˆ
                                    const nextNumber = String(maxNumber + 1).padStart(3, '0');
                                    skuInput.value = `${baseSku}-${nextNumber}`;
                                }
                            }
                        }
                    }
                });
            }
            
            const addBtn = document.getElementById('add-product-btn');
            if (addBtn) {
                addBtn.onclick = () => {
                    const name = document.getElementById('product-name').value.trim();
                    const sku = document.getElementById('product-sku').value.trim().toUpperCase();
                    const presetId = document.getElementById('product-preset').value;
                    
                    if (!name || !sku) {
                        showToast('è£½å“åã¨SKUã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                        return;
                    }
                    
                    const id = genId();
                    const newProduct = { id, sku, name, recipe: [] };
                    
                    if (presetId) {
                        const preset = recipePresets.find(p => p.id === presetId);
                        if (preset) {
                            newProduct.recipe = JSON.parse(JSON.stringify(preset.recipe));
                        }
                    }
                    
                    products.push(newProduct);
                    modal.remove();
                    renderAll();
                    showToast('è£½å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                };
            }
        }

        function deleteProduct(id) {
            const p = products.find(pr => pr.id === id);
            if (!p) return;
            showConfirm('è£½å“å‰Šé™¤', `ã€Œ${p.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹?\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`, () => {
                products = products.filter(pr => pr.id !== id);
                renderAll();
                showToast('è£½å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            });
        }

        function toggleMaterialMaster() {
            const s = document.getElementById('material-master-section');
            if (s) { 
                s.classList.toggle('hidden'); 
                if (!s.classList.contains('hidden')) renderMaterials(); 
            }
        }

        function toggleSuspendedMaterials() {
            showSuspendedMaterials = !showSuspendedMaterials;
            const toggleBtn = document.getElementById('suspended-materials-toggle');
            if (toggleBtn) {
                toggleBtn.textContent = showSuspendedMaterials ? 'ä¿ç•™ææ–™ã‚’éè¡¨ç¤º' : 'ä¿ç•™ææ–™ã‚’è¡¨ç¤º';
            }
            renderMaterials();
        }

        function addMaterial() {
            materials.push({ id: genId(), name: '', code: '', type: 'material', category: '', productName: '', status: 'active' });
            renderMaterials();
        }

        function updateMaterial(id, field, value) {
            const m = materials.find(mat => mat.id === id);
            if (m) {
                const old = m.code;
                m[field] = value;
                if (field === 'code' && value !== old) {
                    ingredients.filter(i => i.material_id === id).forEach(i => { 
                        i.material_code = value; 
                        if (value) i.lot_no = genLot(value); 
                    });
                    renderAll();
                }
            }
        }

        function suspendMaterial(id) {
            const m = materials.find(mat => mat.id === id);
            if (!m) return;
            showConfirm('ææ–™ä¿ç•™', `ææ–™ã€Œ${m.name}ã€ã‚’ä¿ç•™ã«ã—ã¾ã™ã‹?\nä¿ç•™ã«ã™ã‚‹ã¨æ–°è¦ä»•å…¥ã‚ŒãŒã§ããªããªã‚Šã¾ã™ã€‚`, () => {
                m.status = 'suspended';
                renderMaterials();
                showToast('ææ–™ã‚’ä¿ç•™ã«ã—ã¾ã—ãŸ');
            });
        }

        function activateMaterial(id) {
            const m = materials.find(mat => mat.id === id);
            if (!m) return;
            showConfirm('ææ–™å†é–‹', `ææ–™ã€Œ${m.name}ã€ã‚’å†ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã—ã¾ã™ã‹?`, () => {
                m.status = 'active';
                renderMaterials();
                showToast('ææ–™ã‚’å†ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã—ã¾ã—ãŸ');
            });
        }

        function deleteMaterial(id) {
            const m = materials.find(mat => mat.id === id);
            if (!m) return;
            
            // â˜…è¿½åŠ : ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè£½å“ãƒ¬ã‚·ãƒ”ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const usedInProducts = products.filter(product => 
                product.recipe && product.recipe.some(item => item.material_id === id)
            );
            
            if (usedInProducts.length > 0) {
                const productNames = usedInProducts.map(p => `ãƒ»${p.name} (${p.sku})`).join('\n');
                showConfirm('å‰Šé™¤ä¸å¯', 
                    `ææ–™ã€Œ${m.name}ã€ã¯ä»¥ä¸‹ã®è£½å“ãƒ¬ã‚·ãƒ”ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™:\n\n${productNames}\n\nãƒ¬ã‚·ãƒ”ã‹ã‚‰å‰Šé™¤ã—ã¦ã‹ã‚‰ææ–™ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚\n\nâ€»ä½¿ã„åˆ‡ã‚Šå±¥æ­´ã®ã¿ã®å ´åˆã¯å‰Šé™¤å¯èƒ½ã§ã™ã€‚`, 
                    () => {
                        // OKæŠ¼ã—ã¦ã‚‚ä½•ã‚‚ã—ãªã„ï¼ˆå‰Šé™¤ã—ãªã„ï¼‰
                    }
                );
                return;
            }
            
            const ri = ingredients.filter(i => i.material_id === id);
            const ru = usedUpIngredients.filter(i => i.material_id === id);
            
            let warningMsg = `ææ–™ã€Œ${m.name}ã€ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹?\n\n`;
            if (ri.length > 0) warningMsg += `ãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªä»•å…¥ã‚Œãƒ‡ãƒ¼ã‚¿: ${ri.length}ä»¶\n`;
            if (ru.length > 0) warningMsg += `ãƒ»ä½¿ã„åˆ‡ã‚Šå±¥æ­´: ${ru.length}ä»¶\n`;
            warningMsg += `\nã“ã‚Œã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
            
            showConfirm('ææ–™å‰Šé™¤', warningMsg, () => {
                materials = materials.filter(mat => mat.id !== id);
                ingredients = ingredients.filter(i => i.material_id !== id);
                usedUpIngredients = usedUpIngredients.filter(i => i.material_id !== id);
                renderAll();
                showToast('ææ–™ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            });
        }

        function addIngredient() {
            const activeMaterials = materials.filter(m => m.status === 'active');
            if (activeMaterials.length === 0) { 
                showToast('å…ˆã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªææ–™ãƒã‚¹ã‚¿ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„', true);
                return; 
            }
            const fm = activeMaterials[0];
            ingredients.push({ 
                id: genId(), 
                material_id: fm.id, 
                material_code: fm.code, 
                lot_no: genLot(fm.code), 
                date: new Date().toISOString().split('T')[0], 
                qty: 0, 
                price: 0, 
                unit: fm.type === 'packaging' ? 'æš' : 'g', 
                supplier: '', 
                expiry: '' 
            });
            renderAll();
            showToast('ä»•å…¥ã‚Œã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }

        function updateIngredient(id, field, value) {
            const ing = ingredients.find(i => i.id === id);
            if (!ing) return;
            if (field === 'qty' || field === 'price') {
                ing[field] = parseFloat(value) || 0;
            } else if (field === 'material_id') {
                ing[field] = value;
                const m = materials.find(mat => mat.id === value);
                if (m) { 
                    ing.material_code = m.code; 
                    ing.lot_no = genLot(m.code); 
                    ing.unit = m.type === 'packaging' ? 'æš' : 'g'; 
                }
            } else {
                ing[field] = value;
            }
            renderAll();
        }

        function deleteIngredient(id) {
            showConfirm('ä»•å…¥ã‚Œå‰Šé™¤', 'ã“ã®ä»•å…¥ã‚Œãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹?\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚', () => {
                ingredients = ingredients.filter(i => i.id !== id);
                renderAll();
                showToast('ä»•å…¥ã‚Œãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            });
        }

        function toggleUsedUpSection() {
            showUsedUp = !showUsedUp;
            const section = document.getElementById('used-up-section');
            const toggleText = document.getElementById('used-up-toggle-text');
            if (section && toggleText) {
                section.classList.toggle('hidden', !showUsedUp);
                toggleText.textContent = showUsedUp ? 'ğŸ“œ ä½¿ã„åˆ‡ã‚Šå±¥æ­´ã‚’éè¡¨ç¤º' : 'ğŸ“œ ä½¿ã„åˆ‡ã‚Šå±¥æ­´ã‚’è¡¨ç¤º';
                if (showUsedUp) renderUsedUp();
            }
        }

        function markAsUsedUp(id) {
            const ing = ingredients.find(i => i.id === id);
            if (!ing) return;
            showConfirm('ä½¿ã„åˆ‡ã‚Š', `ã€Œ${ing.lot_no}ã€ã‚’ä½¿ã„åˆ‡ã‚Šã«ã—ã¾ã™ã‹?\nä½¿ã„åˆ‡ã‚Šå±¥æ­´ã«ç§»å‹•ã—ã¾ã™ã€‚`, () => {
                ing.used_up_date = new Date().toISOString().split('T')[0];
                usedUpIngredients.push(ing);
                ingredients = ingredients.filter(i => i.id !== id);
                renderAll();
                showToast('ä½¿ã„åˆ‡ã‚Šã«ã—ã¾ã—ãŸ');
            });
        }

        function restoreFromUsedUp(id) {
            const ing = usedUpIngredients.find(i => i.id === id);
            if (!ing) return;
            showConfirm('å¾©å…ƒ', `ã€Œ${ing.lot_no}ã€ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«æˆ»ã—ã¾ã™ã‹?`, () => {
                delete ing.used_up_date;
                ingredients.push(ing);
                usedUpIngredients = usedUpIngredients.filter(i => i.id !== id);
                renderAll();
                showToast('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«å¾©å…ƒã—ã¾ã—ãŸ');
            });
        }

        function deleteUsedUp(id) {
            showConfirm('å±¥æ­´å‰Šé™¤', 'ã“ã®ä½¿ã„åˆ‡ã‚Šå±¥æ­´ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹?\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚', () => {
                usedUpIngredients = usedUpIngredients.filter(i => i.id !== id);
                renderUsedUp();
                showToast('ä½¿ã„åˆ‡ã‚Šå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            });
        }

        // ========== å•†å“ç®¡ç†æ©Ÿèƒ½ ==========

        // å•†å“åŸä¾¡è¨ˆç®—
        function calculatePackageCost(packageId) {
            const pkg = packages.find(p => p.id === packageId);
            if (!pkg || !pkg.contents || pkg.contents.length === 0) return 0;
            
            let totalCost = 0;
            
            pkg.contents.forEach(item => {
                // typeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§è£½å“ã‹åŒ…æã‹åˆ¤å®šï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚productIdã‚‚ãƒã‚§ãƒƒã‚¯ï¼‰
                const isProduct = item.type === 'product' || item.productId;
                
                if (isProduct) {
                    // è£½å“ã®åŸä¾¡
                    const productId = item.productId || item.itemId;
                    const productCost = calculateProductCost(productId);
                    totalCost += productCost * item.quantity;
                } else if (item.type === 'material') {
                    // åŒ…æã®åŸä¾¡ï¼ˆæœ€æ–°ã®ä»•å…¥ã‚Œãƒ­ãƒƒãƒˆã‹ã‚‰è¨ˆç®—ï¼‰
                    const latestLot = ingredients.filter(i => i.material_id === item.itemId)
                        .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    
                    if (latestLot && latestLot.qty > 0) {
                        const unitPrice = latestLot.price / latestLot.qty;
                        totalCost += unitPrice * item.quantity;
                    }
                }
            });
            
            return totalCost;
        }

        // å•†å“ä¸€è¦§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderPackages() {
            const container = document.getElementById('packages-list');
            if (!container) return;
            
            if (packages.length === 0) {
                container.innerHTML = '<div class="empty-state">å•†å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            
            container.innerHTML = packages.map(pkg => {
                const totalCost = calculatePackageCost(pkg.id);
                const sellingPrice = pkg.pricing?.sellingPrice || 0;
                
                // è£½å“ã®åˆè¨ˆæ•°ã‚’è¨ˆç®—ï¼ˆtype='product'ã®ã¿ï¼‰
                const totalProducts = pkg.contents
                    .filter(item => item.type === 'product')
                    .reduce((sum, item) => sum + item.quantity, 0);
                
                // ç²—åˆ©è¨ˆç®—
                let marginRate = 0;
                let grossProfit = 0;
                if (sellingPrice > 0 && totalCost > 0) {
                    grossProfit = sellingPrice - totalCost;
                    marginRate = (grossProfit / sellingPrice * 100).toFixed(1);
                }
                
                const marginColor = marginRate >= 50 ? '#52796f' : marginRate >= 30 ? '#b8956a' : '#a8625f';
                
                // å†…å®¹ã®ç°¡æ½”ãªè¡¨ç¤º
                const contentSummary = pkg.contents.map(item => {
                    if (item.type === 'product') {
                        const product = products.find(p => p.id === item.itemId);
                        return product ? `${esc(product.name)}Ã—${item.quantity}` : '';
                    } else if (item.type === 'material') {
                        const material = materials.find(m => m.id === item.itemId);
                        return material ? `${esc(material.name)}Ã—${item.quantity}` : '';
                    }
                    return '';
                }).filter(Boolean).join(', ');
                
                return `
                    <div class="product-card" style="padding: 14px 16px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <!-- å·¦: å•†å“æƒ…å ± (40%) -->
                            <div style="flex: 2; min-width: 0;">
                                <div style="font-weight: 600; font-size: 17px; margin-bottom: 2px;">${esc(pkg.name)}</div>
                                <div style="font-size: 13px; color: #6c757d; margin-bottom: 2px;">SKU: ${esc(pkg.sku)}</div>
                                <div style="font-size: 13px; color: #6c757d; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${contentSummary}</div>
                            </div>
                            
                            <!-- ä¸­å¤®: åŸä¾¡ãƒ»å£²å€¤ (25%) -->
                            <div style="flex: 1; background: #f8f9fa; padding: 10px 12px; border-radius: 6px; display: flex; gap: 16px; justify-content: space-around;">
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 2px;">åŸä¾¡</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #5a6c7d;">${fmt(totalCost)}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 2px;">å£²å€¤</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #2c3e50;">${sellingPrice > 0 ? fmt(sellingPrice) : 'â€”'}</div>
                                </div>
                            </div>
                            
                            <!-- å³: ç²—åˆ©ç‡ (20%) -->
                            <div style="flex: 1; text-align: center;">
                                ${sellingPrice > 0 ? `
                                    <div style="background: linear-gradient(135deg, ${marginColor}15, ${marginColor}25); padding: 8px 12px; border-radius: 6px; border: 2px solid ${marginColor};">
                                        <div style="font-size: 11px; color: #6c757d; margin-bottom: 2px;">ç²—åˆ©ç‡</div>
                                        <div style="font-size: 24px; font-weight: 700; color: ${marginColor}; line-height: 1;">${marginRate}%</div>
                                        <div style="font-size: 11px; color: #6c757d; margin-top: 2px;">${fmt(grossProfit)}</div>
                                    </div>
                                ` : `
                                    <div style="padding: 8px 12px; background: #f1f3f5; border-radius: 6px;">
                                        <div style="font-size: 13px; color: #6c757d;">å£²å€¤æœªè¨­å®š</div>
                                    </div>
                                `}
                            </div>
                            
                            <!-- å³ç«¯: ãƒœã‚¿ãƒ³ (15%) -->
                            <div style="flex: 0 0 auto; display: flex; gap: 4px; flex-direction: column;">
                                <button class="btn btn-cyan btn-sm" style="padding: 4px 8px; font-size: 13px;" onclick="showPricingSimulator('${pkg.id}')">ğŸ’¹</button>
                                <button class="btn btn-purple btn-sm" style="padding: 4px 8px; font-size: 13px;" onclick="editPackage('${pkg.id}')">âœï¸</button>
                                <button class="btn btn-red btn-sm" style="padding: 4px 8px; font-size: 13px;" onclick="deletePackage('${pkg.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ç²—åˆ©ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼
        function showPricingSimulator(packageId) {
            const pkg = packages.find(p => p.id === packageId);
            if (!pkg) return;
            
            const totalCost = calculatePackageCost(pkg.id);
            const currentPrice = pkg.pricing?.sellingPrice || 0;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 700px;">
                    <div class="modal-header">ğŸ’¹ ç²—åˆ©ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ - ${esc(pkg.name)}</div>
                    <div class="modal-body">
                        <div style="background: #f5ecd8; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 14px; color: #8d7540; margin-bottom: 4px;">å•†å“åŸä¾¡</div>
                            <div style="font-size: 36px; font-weight: 700; color: #7d5d3a;">${fmt(totalCost)}</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- ç›®æ¨™ç²—åˆ©ç‡ã‹ã‚‰å£²å€¤ã‚’è¨ˆç®— -->
                            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px;">
                                <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #2d5a4c;">ç›®æ¨™ç²—åˆ©ç‡ã‹ã‚‰è¨ˆç®—</h4>
                                <label class="form-label">ç›®æ¨™ç²—åˆ©ç‡ (%)</label>
                                <input type="number" class="modal-input" id="target-margin" value="40" min="0" max="99" step="1" 
                                       oninput="calculatePriceFromMargin('${pkg.id}')">
                                <div id="price-from-margin" style="margin-top: 16px; padding: 16px; background: white; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 12px; color: #6c757d;">å¿…è¦ãªå£²å€¤</div>
                                    <div style="font-size: 28px; font-weight: 700; color: #52796f;">â€”</div>
                                </div>
                            </div>
                            
                            <!-- å£²å€¤ã‹ã‚‰ç²—åˆ©ç‡ã‚’è¨ˆç®— -->
                            <div style="background: #e3f2fd; padding: 20px; border-radius: 8px;">
                                <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; color: #3a5569;">å£²å€¤ã‹ã‚‰è¨ˆç®—</h4>
                                <label class="form-label">è²©å£²ä¾¡æ ¼ (å††)</label>
                                <input type="number" class="modal-input" id="target-price" value="${currentPrice}" min="0" step="1" 
                                       oninput="calculateMarginFromPrice('${pkg.id}')">
                                <div id="margin-from-price" style="margin-top: 16px; padding: 16px; background: white; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 12px; color: #6c757d;">é”æˆã•ã‚Œã‚‹ç²—åˆ©ç‡</div>
                                    <div style="font-size: 28px; font-weight: 700; color: #5a6c7d;">â€”</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #fff3e0; padding: 16px; border-radius: 6px;">
                            <strong>ğŸ’¡ å£²å€¤ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ</strong>
                            <div style="margin-top: 12px;">
                                <label class="form-label">æ–°ã—ã„è²©å£²ä¾¡æ ¼</label>
                                <input type="number" class="modal-input" id="new-selling-price" value="${currentPrice}" min="0" step="1">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">é–‰ã˜ã‚‹</button>
                        <button class="btn btn-green" onclick="updatePackagePrice('${pkg.id}')">å£²å€¤ã‚’æ›´æ–°</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            // åˆæœŸè¨ˆç®—
            calculatePriceFromMargin(pkg.id);
            calculateMarginFromPrice(pkg.id);
        }

        function calculatePriceFromMargin(packageId) {
            const pkg = packages.find(p => p.id === packageId);
            if (!pkg) return;
            
            const totalCost = calculatePackageCost(pkg.id);
            const marginInput = document.getElementById('target-margin');
            const resultDiv = document.getElementById('price-from-margin');
            
            if (!marginInput || !resultDiv) return;
            
            const targetMargin = parseFloat(marginInput.value) || 0;
            if (targetMargin <= 0 || targetMargin >= 100) {
                resultDiv.innerHTML = `
                    <div style="font-size: 12px; color: #6c757d;">å¿…è¦ãªå£²å€¤</div>
                    <div style="font-size: 28px; font-weight: 700; color: #52796f;">â€”</div>
                `;
                return;
            }
            
            const requiredPrice = totalCost / (1 - targetMargin / 100);
            const grossProfit = requiredPrice - totalCost;
            
            resultDiv.innerHTML = `
                <div style="font-size: 12px; color: #6c757d;">å¿…è¦ãªå£²å€¤</div>
                <div style="font-size: 28px; font-weight: 700; color: #52796f;">${fmt(requiredPrice)}</div>
                <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">ç²—åˆ©é¡: ${fmt(grossProfit)}</div>
            `;
            
            // æ–°ã—ã„è²©å£²ä¾¡æ ¼æ¬„ã«ã‚‚åæ˜ 
            const newPriceInput = document.getElementById('new-selling-price');
            if (newPriceInput) {
                newPriceInput.value = Math.ceil(requiredPrice);
            }
        }

        function calculateMarginFromPrice(packageId) {
            const pkg = packages.find(p => p.id === packageId);
            if (!pkg) return;
            
            const totalCost = calculatePackageCost(pkg.id);
            const priceInput = document.getElementById('target-price');
            const resultDiv = document.getElementById('margin-from-price');
            
            if (!priceInput || !resultDiv) return;
            
            const sellingPrice = parseFloat(priceInput.value) || 0;
            if (sellingPrice <= totalCost) {
                resultDiv.innerHTML = `
                    <div style="font-size: 12px; color: #6c757d;">é”æˆã•ã‚Œã‚‹ç²—åˆ©ç‡</div>
                    <div style="font-size: 28px; font-weight: 700; color: #a8625f;">èµ¤å­—</div>
                `;
                return;
            }
            
            const grossProfit = sellingPrice - totalCost;
            const marginRate = (grossProfit / sellingPrice * 100).toFixed(1);
            const marginColor = marginRate >= 50 ? '#52796f' : marginRate >= 30 ? '#b8956a' : '#a8625f';
            
            resultDiv.innerHTML = `
                <div style="font-size: 12px; color: #6c757d;">é”æˆã•ã‚Œã‚‹ç²—åˆ©ç‡</div>
                <div style="font-size: 28px; font-weight: 700; color: ${marginColor};">${marginRate}%</div>
                <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">ç²—åˆ©é¡: ${fmt(grossProfit)}</div>
            `;
            
            // æ–°ã—ã„è²©å£²ä¾¡æ ¼æ¬„ã«ã‚‚åæ˜ 
            const newPriceInput = document.getElementById('new-selling-price');
            if (newPriceInput) {
                newPriceInput.value = Math.ceil(sellingPrice);
            }
        }

        function updatePackagePrice(packageId) {
            const pkg = packages.find(p => p.id === packageId);
            if (!pkg) return;
            
            const newPriceInput = document.getElementById('new-selling-price');
            if (!newPriceInput) return;
            
            const newPrice = parseFloat(newPriceInput.value) || 0;
            if (newPrice < 0) {
                showToast('æœ‰åŠ¹ãªä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            if (!pkg.pricing) pkg.pricing = {};
            pkg.pricing.sellingPrice = newPrice;
            
            document.querySelector('.modal-overlay').remove();
            renderAll();
            showToast('è²©å£²ä¾¡æ ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        }

        // å•†å“è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showAddPackageModal(presetId = null) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px;">
                    <div class="modal-header">æ–°ã—ã„å•†å“ã‚’è¿½åŠ </div>
                    <div class="modal-body">
                        ${packagePresets.length > 0 ? `
                        <div class="info-box" style="margin-bottom: 16px;">
                            <label class="form-label">ğŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰é¸æŠï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                            <select class="form-select" id="package-preset-select" onchange="applyPackagePreset(this.value)">
                                <option value="">-- ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠ --</option>
                                ${packagePresets.map(p => `
                                    <option value="${p.id}" ${p.id === presetId ? 'selected' : ''}>
                                        ${esc(p.name)} ${p.sku ? `(${esc(p.sku)})` : ''}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        ` : ''}
                        
                        <label class="form-label">å•†å“å</label>
                        <input type="text" class="modal-input" id="package-name" placeholder="ä¾‹: ã‚¢ã‚½ãƒ¼ãƒˆã‚®ãƒ•ãƒˆãƒœãƒƒã‚¯ã‚¹ 12å€‹å…¥ã‚Š" oninput="autoGeneratePackageSku()">
                        
                        <label class="form-label">å•†å“ã‚³ãƒ¼ãƒ‰ (SKU) <span class="text-sm text-gray">â€»å•†å“åã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™</span></label>
                        <input type="text" class="modal-input" id="package-sku" placeholder="ä¾‹: BOX-ASSORT-001">
                        
                        <label class="form-label">èª¬æ˜ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
                        <input type="text" class="modal-input" id="package-description" placeholder="ä¾‹: 3ç¨®é¡ã®ã‚¯ãƒƒã‚­ãƒ¼è©°ã‚åˆã‚ã›">
                        
                        <div style="margin: 20px 0; padding-top: 16px; border-top: 2px solid #e9ecef;">
                            <div class="flex justify-between items-center" style="margin-bottom: 12px;">
                                <strong style="font-size: 18px;">ğŸ“¦ å†…å®¹æ§‹æˆ</strong>
                                <button class="btn btn-primary btn-sm" onclick="addPackageContentItem()">+ è£½å“ã‚’è¿½åŠ </button>
                            </div>
                            <div id="package-contents">
                                <!-- å†…å®¹ã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                            </div>
                        </div>
                        
                        <div style="background: #f5ecd8; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #8d7540;">åˆè¨ˆåŸä¾¡</div>
                            <div id="package-total-cost" style="font-size: 28px; font-weight: 700; color: #7d5d3a;">Â¥0</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="btn btn-green" id="save-package-btn">ä¿å­˜</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            // åˆæœŸçŠ¶æ…‹ã§1ã¤ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
            window.packageContents = [];
            addPackageContentItem();
            
            // ä¿å­˜ãƒœã‚¿ãƒ³
            document.getElementById('save-package-btn').onclick = () => {
                const name = document.getElementById('package-name').value.trim();
                const sku = document.getElementById('package-sku').value.trim().toUpperCase();
                const description = document.getElementById('package-description').value.trim();
                
                if (!name || !sku) {
                    showToast('å•†å“åã¨SKUã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                    return;
                }
                
                if (window.packageContents.length === 0) {
                    showToast('å°‘ãªãã¨ã‚‚1ã¤ã®è£½å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„', true);
                    return;
                }
                
                // å…¨ã¦ã®è£½å“ãŒé¸æŠã•ã‚Œã€æ•°é‡ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const invalid = window.packageContents.filter(item => !item.productId || item.quantity <= 0);
                if (invalid.length > 0) {
                    showToast('ã™ã¹ã¦ã®è£½å“ã‚’é¸æŠã—ã€æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                    return;
                }
                
                const newPackage = {
                    id: genId(),
                    sku: sku,
                    name: name,
                    description: description,
                    contents: window.packageContents.map(item => ({
                        type: 'product',
                        itemId: item.productId,
                        quantity: item.quantity
                    })),
                    pricing: { 
                        sellingPrice: window.presetSellingPrice || 0, 
                        targetMargin: 0 
                    }
                };
                
                // ãƒ—ãƒªã‚»ãƒƒãƒˆå£²å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
                window.presetSellingPrice = 0;
                
                packages.push(newPackage);
                modal.remove();
                renderAll();
                showToast('å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
            };
            
            // ãƒ—ãƒªã‚»ãƒƒãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é©ç”¨
            if (presetId) {
                setTimeout(() => applyPackagePreset(presetId), 100);
            }
        }

        function autoGeneratePackageSku() {
            const nameInput = document.getElementById('package-name');
            const skuInput = document.getElementById('package-sku');
            
            if (!nameInput || !skuInput) return;
            
            const name = nameInput.value.trim();
            if (!name) {
                skuInput.value = '';
                return;
            }
            
            // å•†å“åã‹ã‚‰ãƒ™ãƒ¼ã‚¹SKUã‚’ç”Ÿæˆï¼ˆæœ€åˆã®10æ–‡å­—ã¾ã§ã€è‹±æ•°å­—ã®ã¿ï¼‰
            const baseSku = 'BOX-' + name
                .substring(0, 10)
                .toUpperCase()
                .replace(/[^A-Z0-9]/g, '')
                .substring(0, 8);
            
            // è‡ªå‹•æ¡ç•ª
            const generatedSku = genPackageSku(baseSku);
            skuInput.value = generatedSku;
        }

        function applyPackagePreset(presetId) {
            if (!presetId) return;
            
            const preset = packagePresets.find(p => p.id === presetId);
            if (!preset) return;
            
            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
            const nameInput = document.getElementById('package-name');
            const skuInput = document.getElementById('package-sku');
            
            if (nameInput && !nameInput.value) {
                nameInput.value = preset.name;
            }
            if (skuInput && !skuInput.value) {
                skuInput.value = preset.sku || '';
            }
            
            // å£²å€¤ã‚’ä¿å­˜ï¼ˆæ–°è¦ä½œæˆæ™‚ã«ä½¿ç”¨ï¼‰
            window.presetSellingPrice = preset.sellingPrice || 0;
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¨­å®šï¼ˆè£½å“ã®ã¿ï¼‰
            window.packageContents = [];
            if (preset.contents) {
                preset.contents.forEach(item => {
                    if (item.type === 'product') {
                        window.packageContents.push({
                            productId: item.itemId,
                            quantity: item.quantity
                        });
                    }
                });
            }
            
            renderPackageContents();
            showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸ');
        }

        // å•†å“ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ 
        function addPackageContentItem() {
            if (products.length === 0) {
                showToast('å…ˆã«è£½å“ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            const index = window.packageContents.length;
            window.packageContents.push({ productId: '', quantity: 1 });
            
            renderPackageContents();
        }

        // å•†å“ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderPackageContents() {
            const container = document.getElementById('package-contents');
            if (!container) return;
            
            if (window.packageContents.length === 0) {
                container.innerHTML = '<div class="text-center text-gray" style="padding: 20px;">è£½å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
                return;
            }
            
            container.innerHTML = window.packageContents.map((item, index) => {
                const selectedProduct = products.find(p => p.id === item.productId);
                const unitCost = item.productId ? calculateProductCost(item.productId) : 0;
                const subtotal = unitCost * (item.quantity || 0);
                
                return `
                    <div style="background: #fafbfc; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 12px; align-items: center;">
                            <div>
                                <label class="form-label" style="margin-bottom: 4px;">è£½å“</label>
                                <select class="form-select" onchange="updatePackageContent(${index}, 'productId', this.value)">
                                    <option value="">-- è£½å“ã‚’é¸æŠ --</option>
                                    ${products.map(p => `
                                        <option value="${p.id}" ${p.id === item.productId ? 'selected' : ''}>
                                            ${esc(p.name)} (${esc(p.sku)})
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="form-label" style="margin-bottom: 4px;">æ•°é‡</label>
                                <input type="number" class="form-input" value="${item.quantity}" min="1" 
                                       onchange="updatePackageContent(${index}, 'quantity', parseInt(this.value) || 1)"
                                       style="text-align: center;">
                            </div>
                            <div style="text-align: right; padding-top: 24px;">
                                <button class="btn btn-red btn-sm" onclick="removePackageContent(${index})">å‰Šé™¤</button>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between;">
                            <div class="text-sm text-gray">å˜ä¾¡: ${fmt(unitCost)}</div>
                            <div class="font-bold text-orange">å°è¨ˆ: ${fmt(subtotal)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            updatePackageTotalCost();
        }

        // å•†å“ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°
        function updatePackageContent(index, field, value) {
            if (window.packageContents[index]) {
                window.packageContents[index][field] = field === 'quantity' ? (parseInt(value) || 1) : value;
                renderPackageContents();
            }
        }

        // å•†å“ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å‰Šé™¤
        function removePackageContent(index) {
            window.packageContents.splice(index, 1);
            renderPackageContents();
        }

        // å•†å“åˆè¨ˆåŸä¾¡æ›´æ–°
        function updatePackageTotalCost() {
            const totalCostElement = document.getElementById('package-total-cost');
            if (!totalCostElement) return;
            
            let totalCost = 0;
            window.packageContents.forEach(item => {
                if (item.productId && item.quantity > 0) {
                    const unitCost = calculateProductCost(item.productId);
                    totalCost += unitCost * item.quantity;
                }
            });
            
            totalCostElement.textContent = fmt(totalCost);
        }

        // å•†å“ç·¨é›†
        function editPackage(id) {
            const pkg = packages.find(p => p.id === id);
            if (!pkg) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px;">
                    <div class="modal-header">å•†å“ã‚’ç·¨é›†</div>
                    <div class="modal-body">
                        <label class="form-label">å•†å“å</label>
                        <input type="text" class="modal-input" id="package-name" value="${esc(pkg.name)}">
                        
                        <label class="form-label">å•†å“ã‚³ãƒ¼ãƒ‰ (SKU)</label>
                        <input type="text" class="modal-input" id="package-sku" value="${esc(pkg.sku)}">
                        
                        <label class="form-label">èª¬æ˜ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
                        <input type="text" class="modal-input" id="package-description" value="${esc(pkg.description || '')}">
                        
                        <div style="margin: 20px 0; padding-top: 16px; border-top: 2px solid #e9ecef;">
                            <div class="flex justify-between items-center" style="margin-bottom: 12px;">
                                <strong style="font-size: 18px;">ğŸ“¦ å†…å®¹æ§‹æˆ</strong>
                                <button class="btn btn-primary btn-sm" onclick="addPackageContentItem()">+ è£½å“ã‚’è¿½åŠ </button>
                            </div>
                            <div id="package-contents">
                                <!-- å†…å®¹ã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                            </div>
                        </div>
                        
                        <div style="background: #f5ecd8; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #8d7540;">åˆè¨ˆåŸä¾¡</div>
                            <div id="package-total-cost" style="font-size: 28px; font-weight: 700; color: #7d5d3a;">Â¥0</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="btn btn-green" id="save-package-btn">ä¿å­˜</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            // æ—¢å­˜ã®å†…å®¹ã‚’èª­ã¿è¾¼ã‚€ï¼ˆè£½å“ã®ã¿ã€æ–°ã—ã„æ§‹é€ ã«å¯¾å¿œï¼‰
            window.packageContents = pkg.contents
                .filter(item => item.type === 'product')
                .map(item => ({
                    productId: item.itemId,
                    quantity: item.quantity
                }));
            renderPackageContents();
            
            // ä¿å­˜ãƒœã‚¿ãƒ³
            document.getElementById('save-package-btn').onclick = () => {
                const name = document.getElementById('package-name').value.trim();
                const sku = document.getElementById('package-sku').value.trim().toUpperCase();
                const description = document.getElementById('package-description').value.trim();
                
                if (!name || !sku) {
                    showToast('å•†å“åã¨SKUã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                    return;
                }
                
                if (window.packageContents.length === 0) {
                    showToast('å°‘ãªãã¨ã‚‚1ã¤ã®è£½å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„', true);
                    return;
                }
                
                const invalid = window.packageContents.filter(item => !item.productId || item.quantity <= 0);
                if (invalid.length > 0) {
                    showToast('ã™ã¹ã¦ã®è£½å“ã‚’é¸æŠã—ã€æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                    return;
                }
                
                pkg.name = name;
                pkg.sku = sku;
                pkg.description = description;
                pkg.contents = window.packageContents.map(item => ({
                    type: 'product',
                    itemId: item.productId,
                    quantity: item.quantity
                }));
                
                modal.remove();
                renderAll();
                showToast('å•†å“ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            };
        }

        // å•†å“å‰Šé™¤
        function deletePackage(id) {
            const pkg = packages.find(p => p.id === id);
            if (!pkg) return;
            
            showConfirm('å•†å“å‰Šé™¤', `å•†å“ã€Œ${pkg.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹?\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`, () => {
                packages = packages.filter(p => p.id !== id);
                renderAll();
                showToast('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            });
        }

        // ========== ã“ã“ã¾ã§å•†å“ç®¡ç†æ©Ÿèƒ½ ==========

        // â˜…è¿½åŠ : å•†å“è©³ç´°è¡¨ç¤º
        function showPackageDetail(id) {
            const pkg = packages.find(p => p.id === id);
            if (!pkg) return;
            
            const totalCost = calculatePackageCost(id);
            let marginRate = 0;
            let grossProfit = 0;
            
            if (pkg.pricing && pkg.pricing.sellingPrice > 0 && totalCost > 0) {
                grossProfit = pkg.pricing.sellingPrice - totalCost;
                marginRate = (grossProfit / pkg.pricing.sellingPrice * 100).toFixed(1);
            }
            
            let contentsHtml = '<div style="margin-top: 16px;">';
            
            // è£½å“
            const productContents = (pkg.contents || []).filter(c => c.type === 'product');
            if (productContents.length > 0) {
                contentsHtml += '<h4 style="color: #667eea; margin-bottom: 12px;">ã€è£½å“ã€‘</h4>';
                productContents.forEach(item => {
                    const product = products.find(p => p.id === item.productId || p.id === item.itemId);
                    const unitCost = product ? calculateProductCost(product.id) : 0;
                    const subtotal = unitCost * item.quantity;
                    contentsHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f3f5;">
                            <div>${product ? esc(product.name) : 'ä¸æ˜'} Ã— ${item.quantity}å€‹</div>
                            <div>${fmt(subtotal)}</div>
                        </div>
                    `;
                });
            }
            
            // åŒ…æ
            const materialContents = (pkg.contents || []).filter(c => c.type === 'material');
            if (materialContents.length > 0) {
                contentsHtml += '<h4 style="color: #667eea; margin: 16px 0 12px;">ã€åŒ…æã€‘</h4>';
                materialContents.forEach(item => {
                    const material = materials.find(m => m.id === item.itemId);
                    // åŒ…æã®å˜ä¾¡ã‚’è¨ˆç®—ï¼ˆæœ€æ–°ã®ä»•å…¥ã‚Œãƒ­ãƒƒãƒˆã‹ã‚‰ï¼‰
                    const latestLot = ingredients.filter(i => i.material_id === item.itemId)
                        .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    const unitCost = latestLot ? (latestLot.price / latestLot.qty) : 0;
                    const subtotal = unitCost * item.quantity;
                    contentsHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f3f5;">
                            <div>${material ? esc(material.name) : 'ä¸æ˜'} Ã— ${item.quantity}${material ? material.type === 'packaging' ? 'æš' : 'g' : ''}</div>
                            <div>${fmt(subtotal)}</div>
                        </div>
                    `;
                });
            }
            
            contentsHtml += '</div>';
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 700px;">
                    <div class="modal-header">å•†å“è©³ç´°: ${esc(pkg.name)}</div>
                    <div class="modal-body">
                        <div style="margin-bottom: 16px;">
                            <strong>SKU:</strong> ${esc(pkg.sku)}<br>
                            ${pkg.description ? `<strong>èª¬æ˜:</strong> ${esc(pkg.description)}` : ''}
                        </div>
                        
                        ${contentsHtml}
                        
                        <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #f5ecd8, #e5dcc8); border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; text-align: center;">
                                <div>
                                    <div style="font-size: 14px; color: #8d7540;">åŸä¾¡</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #7d5d3a;">${fmt(totalCost)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #8d7540;">è²©å£²ä¾¡æ ¼</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #7d5d3a;">
                                        ${pkg.pricing && pkg.pricing.sellingPrice > 0 ? fmt(pkg.pricing.sellingPrice) : 'â€”'}
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #8d7540;">ç²—åˆ©ç‡</div>
                                    <div style="font-size: 24px; font-weight: 700; color: ${marginRate >= 50 ? '#28a745' : marginRate >= 30 ? '#b8956a' : '#dc3545'};">
                                        ${marginRate > 0 ? marginRate + '%' : 'â€”'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-purple" onclick="this.closest('.modal-overlay').remove(); editPackage('${id}');">ç·¨é›†</button>
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
        }

        // â˜…è¿½åŠ : å•†å“ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function showPackagePresetManager() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 900px;">
                    <div class="modal-header">å•†å“ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†</div>
                    <div class="modal-body">
                        <div class="info-box" style="margin-bottom: 16px;">
                            ğŸ’¡ ã‚ˆãä½¿ã†å•†å“ã®çµ„ã¿åˆã‚ã›ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆã¨ã—ã¦ä¿å­˜ã§ãã¾ã™<br>
                            ğŸ’¡ æ–°ã—ã„å•†å“ã‚’è¿½åŠ ã™ã‚‹éš›ã«ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰é¸æŠã§ãã¾ã™
                        </div>
                        <div style="margin-bottom: 16px;">
                            <button class="btn btn-green btn-sm" onclick="showCreatePackagePresetModal()">â• æ–°ã—ã„ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½œæˆ</button>
                        </div>
                        <div id="package-preset-manager-list"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            renderPackagePresetManagerList();
        }

        function renderPackagePresetManagerList() {
            const container = document.getElementById('package-preset-manager-list');
            if (!container) return;
            
            if (packagePresets.length === 0) {
                container.innerHTML = '<div class="empty-state"><p class="text-sm text-gray">ãƒ—ãƒªã‚»ãƒƒãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
                return;
            }
            
            container.innerHTML = packagePresets.map(preset => {
                const productCount = preset.contents ? preset.contents.filter(c => c.type === 'product').length : 0;
                const materialCount = preset.contents ? preset.contents.filter(c => c.type === 'material').length : 0;
                
                return `
                    <div class="product-card">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <div style="font-weight: 600; font-size: 18px; margin-bottom: 4px;">${esc(preset.name)}</div>
                                <div class="text-sm text-gray">
                                    è£½å“: ${productCount}ç¨®é¡ / åŒ…æ: ${materialCount}ç¨®é¡
                                    ${preset.sku ? ` / SKU: ${esc(preset.sku)}` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="showEditPackagePresetModal('${preset.id}')">ç·¨é›†</button>
                                <button class="btn btn-red btn-sm" onclick="deletePackagePreset('${preset.id}')">å‰Šé™¤</button>
                            </div>
                        </div>
                        <div style="font-size: 15px; color: #6c757d;">
                            ${preset.contents && preset.contents.length > 0 ? preset.contents.map(item => {
                                if (item.type === 'product') {
                                    const product = products.find(p => p.id === item.itemId);
                                    return product ? `â€¢ è£½å“: ${esc(product.name)} Ã— ${item.quantity}å€‹` : '';
                                } else if (item.type === 'material') {
                                    const material = materials.find(m => m.id === item.itemId);
                                    return material ? `â€¢ åŒ…æ: ${esc(material.name)} Ã— ${item.quantity}${material.type === 'packaging' ? 'æš' : 'g'}` : '';
                                }
                                return '';
                            }).filter(Boolean).join('<br>') : 'ã¾ã å†…å®¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showCreatePackagePresetModal() {
            if (products.length === 0) {
                showToast('å…ˆã«è£½å“ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            window.packagePresetContents = [];
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px;">
                    <div class="modal-header">æ–°ã—ã„å•†å“ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½œæˆ</div>
                    <div class="modal-body">
                        <div class="grid grid-2">
                            <div>
                                <label class="form-label">ãƒ—ãƒªã‚»ãƒƒãƒˆå</label>
                                <input type="text" class="modal-input" id="package-preset-name" placeholder="ä¾‹: æ˜¥ã®ã‚®ãƒ•ãƒˆã‚»ãƒƒãƒˆ">
                            </div>
                            <div>
                                <label class="form-label">SKUï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                                <input type="text" class="modal-input" id="package-preset-sku" placeholder="ä¾‹: BOX-SPRING-001">
                            </div>
                        </div>
                        
                        <label class="form-label">æƒ³å®šå£²å€¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                        <input type="number" class="modal-input" id="package-preset-price" placeholder="ä¾‹: 1200" min="0" step="1" oninput="updatePresetMarginPreview()">
                        
                        <div style="margin: 20px 0; padding-top: 16px; border-top: 2px solid #e9ecef;">
                            <div class="flex justify-between items-center" style="margin-bottom: 12px;">
                                <strong style="font-size: 18px;">ğŸ“¦ å†…å®¹æ§‹æˆ</strong>
                                <div class="flex gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="addPackagePresetProduct()">+ è£½å“</button>
                                    <button class="btn btn-purple btn-sm" onclick="addPackagePresetMaterial()">+ åŒ…æ</button>
                                </div>
                            </div>
                            <div id="package-preset-contents">
                                <div class="text-center text-gray" style="padding: 20px;">è£½å“ã¾ãŸã¯åŒ…æã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>
                            </div>
                        </div>
                        
                        <div id="preset-cost-preview" style="background: #f0f5f9; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #6c757d;">æƒ³å®šåŸä¾¡</div>
                            <div style="font-size: 24px; font-weight: 600; color: #5a6c7d;">Â¥0</div>
                            <div id="preset-margin-preview" style="margin-top: 8px; font-size: 14px; color: #6c757d;"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="btn btn-green" onclick="createPackagePreset()">ä½œæˆ</button>
                    </div>
                </div>
            `;
            const parentModal = document.querySelector('.modal-overlay');
            if (parentModal) {
                parentModal.appendChild(modal);
            } else {
                document.getElementById('modal-container').appendChild(modal);
            }
            document.getElementById('package-preset-name').focus();
        }

        function addPackagePresetProduct() {
            if (products.length === 0) {
                showToast('å…ˆã«è£½å“ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„', true);
                return;
            }
            window.packagePresetContents.push({ type: 'product', itemId: '', quantity: 1 });
            renderPackagePresetContents();
        }

        function addPackagePresetMaterial() {
            const packagingMaterials = materials.filter(m => m.type === 'packaging' && m.status === 'active');
            if (packagingMaterials.length === 0) {
                showToast('å…ˆã«åŒ…æï¼ˆtype=packagingï¼‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„', true);
                return;
            }
            window.packagePresetContents.push({ type: 'material', itemId: '', quantity: 1 });
            renderPackagePresetContents();
        }

        function renderPackagePresetContents() {
            const container = document.getElementById('package-preset-contents');
            if (!container) return;
            
            if (window.packagePresetContents.length === 0) {
                container.innerHTML = '<div class="text-center text-gray" style="padding: 20px;">è£½å“ã¾ãŸã¯åŒ…æã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
                return;
            }
            
            container.innerHTML = window.packagePresetContents.map((item, index) => {
                if (item.type === 'product') {
                    return `
                        <div style="background: #fafbfc; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 12px; align-items: center;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 4px;">è£½å“</label>
                                    <select class="form-select" onchange="updatePackagePresetContent(${index}, 'itemId', this.value)">
                                        <option value="">-- è£½å“ã‚’é¸æŠ --</option>
                                        ${products.map(p => `
                                            <option value="${p.id}" ${p.id === item.itemId ? 'selected' : ''}>
                                                ${esc(p.name)} (${esc(p.sku)})
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label" style="margin-bottom: 4px;">æ•°é‡</label>
                                    <input type="number" class="form-input" value="${item.quantity}" min="1" 
                                           onchange="updatePackagePresetContent(${index}, 'quantity', parseInt(this.value) || 1)"
                                           style="text-align: center;">
                                </div>
                                <div style="text-align: right; padding-top: 24px;">
                                    <button class="btn btn-red btn-sm" onclick="removePackagePresetContent(${index})">å‰Šé™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (item.type === 'material') {
                    const packagingMaterials = materials.filter(m => m.type === 'packaging' && m.status === 'active');
                    return `
                        <div style="background: #f0e5f8; border: 1px solid #d4c5e8; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 12px; align-items: center;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 4px;">åŒ…æ</label>
                                    <select class="form-select" onchange="updatePackagePresetContent(${index}, 'itemId', this.value)">
                                        <option value="">-- åŒ…æã‚’é¸æŠ --</option>
                                        ${packagingMaterials.map(m => `
                                            <option value="${m.id}" ${m.id === item.itemId ? 'selected' : ''}>
                                                ${esc(m.name)} (${esc(m.code)})
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label" style="margin-bottom: 4px;">æ•°é‡</label>
                                    <input type="number" class="form-input" value="${item.quantity}" min="1" 
                                           onchange="updatePackagePresetContent(${index}, 'quantity', parseInt(this.value) || 1)"
                                           style="text-align: center;">
                                </div>
                                <div style="text-align: right; padding-top: 24px;">
                                    <button class="btn btn-red btn-sm" onclick="removePackagePresetContent(${index})">å‰Šé™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                return '';
            }).join('');
        }

        function updatePackagePresetContent(index, field, value) {
            if (window.packagePresetContents[index]) {
                window.packagePresetContents[index][field] = field === 'quantity' ? (parseInt(value) || 1) : value;
                renderPackagePresetContents();
                updatePresetMarginPreview();
            }
        }

        function updatePresetMarginPreview() {
            const costPreview = document.getElementById('preset-cost-preview');
            const marginPreview = document.getElementById('preset-margin-preview');
            const priceInput = document.getElementById('package-preset-price');
            
            if (!costPreview || !marginPreview || !priceInput) return;
            
            // åŸä¾¡ã‚’è¨ˆç®—
            let totalCost = 0;
            window.packagePresetContents.forEach(item => {
                if (item.type === 'product' && item.itemId) {
                    const unitCost = calculateProductCost(item.itemId);
                    totalCost += unitCost * item.quantity;
                } else if (item.type === 'material' && item.itemId) {
                    const latestIngredient = ingredients
                        .filter(i => i.material_id === item.itemId)
                        .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    if (latestIngredient) {
                        const unitCost = latestIngredient.price / latestIngredient.qty;
                        totalCost += unitCost * item.quantity;
                    }
                }
            });
            
            costPreview.querySelector('div:nth-child(2)').textContent = fmt(totalCost);
            
            // ç²—åˆ©ç‡ã‚’è¨ˆç®—
            const sellingPrice = parseFloat(priceInput.value) || 0;
            if (sellingPrice > 0 && totalCost > 0) {
                const grossProfit = sellingPrice - totalCost;
                const marginRate = (grossProfit / sellingPrice * 100).toFixed(1);
                const marginColor = marginRate >= 50 ? '#52796f' : marginRate >= 30 ? '#b8956a' : '#a8625f';
                marginPreview.innerHTML = `<span style="color: ${marginColor}; font-weight: 600;">æƒ³å®šç²—åˆ©ç‡: ${marginRate}% (ç²—åˆ©é¡: ${fmt(grossProfit)})</span>`;
            } else {
                marginPreview.innerHTML = '';
            }
        }

        function removePackagePresetContent(index) {
            window.packagePresetContents.splice(index, 1);
            renderPackagePresetContents();
            updatePresetMarginPreview();
        }

        function createPackagePreset() {
            const name = document.getElementById('package-preset-name').value.trim();
            const sku = document.getElementById('package-preset-sku').value.trim();
            const price = parseFloat(document.getElementById('package-preset-price').value) || 0;
            
            if (!name) {
                showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            if (window.packagePresetContents.length === 0) {
                showToast('å°‘ãªãã¨ã‚‚1ã¤ã®è£½å“ã¾ãŸã¯åŒ…æã‚’è¿½åŠ ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            const invalid = window.packagePresetContents.filter(item => !item.itemId || item.quantity <= 0);
            if (invalid.length > 0) {
                showToast('ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã€æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            packagePresets.push({
                id: genId(),
                name: name,
                sku: sku,
                sellingPrice: price,
                contents: window.packagePresetContents.map(item => ({...item}))
            });
            
            document.querySelectorAll('.modal-overlay').forEach(m => m.remove());
            showPackagePresetManager();
            showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
        }

        function showEditPackagePresetModal(presetId) {
            const preset = packagePresets.find(p => p.id === presetId);
            if (!preset) return;
            
            window.packagePresetContents = preset.contents ? preset.contents.map(item => ({...item})) : [];
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px;">
                    <div class="modal-header">ãƒ—ãƒªã‚»ãƒƒãƒˆç·¨é›†</div>
                    <div class="modal-body">
                        <div class="grid grid-2">
                            <div>
                                <label class="form-label">ãƒ—ãƒªã‚»ãƒƒãƒˆå</label>
                                <input type="text" class="modal-input" id="edit-package-preset-name" value="${esc(preset.name)}">
                            </div>
                            <div>
                                <label class="form-label">SKUï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                                <input type="text" class="modal-input" id="edit-package-preset-sku" value="${esc(preset.sku || '')}">
                            </div>
                        </div>
                        
                        <label class="form-label">æƒ³å®šå£²å€¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                        <input type="number" class="modal-input" id="edit-package-preset-price" value="${preset.sellingPrice || ''}" placeholder="ä¾‹: 1200" min="0" step="1" oninput="updatePresetMarginPreview()">
                        
                        <div style="margin: 20px 0; padding-top: 16px; border-top: 2px solid #e9ecef;">
                            <div class="flex justify-between items-center" style="margin-bottom: 12px;">
                                <strong style="font-size: 18px;">ğŸ“¦ å†…å®¹æ§‹æˆ</strong>
                                <div class="flex gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="addPackagePresetProduct()">+ è£½å“</button>
                                    <button class="btn btn-purple btn-sm" onclick="addPackagePresetMaterial()">+ åŒ…æ</button>
                                </div>
                            </div>
                            <div id="package-preset-contents"></div>
                        </div>
                        
                        <div id="preset-cost-preview" style="background: #f0f5f9; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 14px; color: #6c757d;">æƒ³å®šåŸä¾¡</div>
                            <div style="font-size: 24px; font-weight: 600; color: #5a6c7d;">Â¥0</div>
                            <div id="preset-margin-preview" style="margin-top: 8px; font-size: 14px; color: #6c757d;"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-gray" onclick="this.closest('.modal-overlay').remove(); showPackagePresetManager();">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="btn btn-green" onclick="savePackagePresetEdit('${presetId}')">ä¿å­˜</button>
                    </div>
                </div>
            `;
            
            const parentModal = document.querySelector('.modal-overlay');
            if (parentModal) {
                parentModal.appendChild(modal);
            } else {
                document.getElementById('modal-container').appendChild(modal);
            }
            
            document.getElementById('edit-package-preset-name').focus();
            renderPackagePresetContents();
            updatePresetMarginPreview();
        }

        function savePackagePresetEdit(presetId) {
            const preset = packagePresets.find(p => p.id === presetId);
            if (!preset) return;
            
            const newName = document.getElementById('edit-package-preset-name').value.trim();
            const newSku = document.getElementById('edit-package-preset-sku').value.trim();
            const newPrice = parseFloat(document.getElementById('edit-package-preset-price').value) || 0;
            
            if (!newName) {
                showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            if (window.packagePresetContents.length === 0) {
                showToast('å°‘ãªãã¨ã‚‚1ã¤ã®è£½å“ã¾ãŸã¯åŒ…æã‚’è¿½åŠ ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            const invalid = window.packagePresetContents.filter(item => !item.itemId || item.quantity <= 0);
            if (invalid.length > 0) {
                showToast('ã™ã¹ã¦ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã€æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            preset.name = newName;
            preset.sku = newSku;
            preset.sellingPrice = newPrice;
            preset.contents = window.packagePresetContents.map(item => ({...item}));
            
            document.querySelectorAll('.modal-overlay').forEach(m => m.remove());
            showPackagePresetManager();
            showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        }

        function deletePackagePreset(presetId) {
            const preset = packagePresets.find(p => p.id === presetId);
            if (!preset) return;
            
            showConfirm('ãƒ—ãƒªã‚»ãƒƒãƒˆå‰Šé™¤', `ã€Œ${preset.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹?`, () => {
                packagePresets = packagePresets.filter(p => p.id !== presetId);
                renderPackagePresetManagerList();
                showToast('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            });
        }


        async function saveDataToCloud() {
            if (!API_BASE || API_BASE.includes('YOUR_API_ID')) {
                showToast('API_BASE ã‚’CDKãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®URLã«è¨­å®šã—ã¦ãã ã•ã„', true);
                return;
            }
            setLoading(true);
            
            const data = { 
                products, 
                materials, 
                ingredients, 
                usedUpIngredients,
                recipePresets,
                packages,
                packagePresets,  // â˜…è¿½åŠ 
                exportDate: new Date().toISOString() 
            };
            
            try {
                const signRes = await fetch(`${API_BASE}/sign-upload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tool: TOOL_ID })
                });
                if (!signRes.ok) throw new Error('ç½²åä»˜ãURLå–å¾—ã«å¤±æ•—');
                const { uploadUrl, key, latestPutUrl } = await signRes.json();
                
                await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (latestPutUrl) {
                    await fetch(latestPutUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-store' },
                        body: JSON.stringify({ key, updatedAt: new Date().toISOString() })
                    });
                }
                
                showToast('ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (err) {
                console.error('save error', err);
                showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            } finally {
                setLoading(false);
            }
        }

        async function loadLatestFromCloud() {
            if (!API_BASE || API_BASE.includes('YOUR_API_ID')) return;
            setLoading(true);
            try {
                const res = await fetch(`${API_BASE}/latest?tool=${encodeURIComponent(TOOL_ID)}`, {
                    method: 'GET',
                    headers: { 'Cache-Control': 'no-store' }
                });
                if (res.status === 404) {
                    console.info('ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                if (!res.ok) throw new Error('latestå‘¼ã³å‡ºã—ã«å¤±æ•—');
                const meta = await res.json();
                if (!meta.dataUrl) throw new Error('dataUrlãªã—');
                const dataRes = await fetch(meta.dataUrl, { cache: 'no-store' });
                if (!dataRes.ok) throw new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—');
                const payload = await dataRes.json();
                applyLoadedData(payload, false);
                showToast('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
            } catch (err) {
                console.error('load error', err);
                showToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            } finally {
                setLoading(false);
            }
        }

        function applyLoadedData(d, shouldToast = true) {
                        products = d.products || [];
                        materials = d.materials || [];
                        ingredients = d.ingredients || [];
                        usedUpIngredients = d.usedUpIngredients || [];
                        recipePresets = d.recipePresets || [];
                        packages = d.packages || [];
                        packagePresets = d.packagePresets || [];  // â˜…è¿½åŠ 
                        renderAll();
            if (shouldToast) showToast('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        }

        function importData(e) {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                try {
                    const d = JSON.parse(ev.target.result);
                    showConfirm('ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 'ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹?', () => {
                        applyLoadedData(d, true);
                    });
                } catch (err) {
                    showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
                    console.error('Import error:', err);
                }
            };
            r.readAsText(f);
            e.target.value = '';
        }

        function renderAll() { 
            checkExpiryAlerts();
            renderDashboard(); 
            renderMaterials(); 
            renderIngredients();
            renderProducts();  // â˜…è¿½åŠ 
            renderPackages();
            if (showUsedUp) renderUsedUp();
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
        function setLoading(isLoading) {
            const overlay = document.getElementById('loadingOverlay');
            if (!overlay) return;
            if (isLoading) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        // â˜…è¿½åŠ : è£½å“ä¸€è¦§è¡¨ç¤ºé–¢æ•°
        function renderProducts() {
            const tbody = document.getElementById('products-table-body');
            if (!tbody) return;
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray">è£½å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(p => {
                const hasRecipe = p.recipe && p.recipe.length > 0;
                const cost = hasRecipe ? calculateProductCost(p.id) : 0;
                const recipeStatus = hasRecipe ? 
                    `<span class="badge badge-green">è¨­å®šæ¸ˆã¿ (${p.recipe.length}ç¨®)</span>` : 
                    `<span class="badge badge-gray">æœªè¨­å®š</span>`;
                const costDisplay = hasRecipe && cost > 0 ? 
                    `<span class="font-bold text-green">${fmtDec(cost)}</span>` : 
                    `<span class="text-gray">â€”</span>`;
                
                return `
                    <tr>
                        <td>
                            <span class="clickable-product" onclick="showRecipeEditor('${p.id}')">${esc(p.name)}</span>
                        </td>
                        <td class="text-sm text-gray">${esc(p.sku)}</td>
                        <td>${recipeStatus}</td>
                        <td class="text-right">${costDisplay}</td>
                        <td class="text-center">
                            <button class="btn btn-purple btn-sm" onclick="showRecipeEditor('${p.id}')">ãƒ¬ã‚·ãƒ”ç·¨é›†</button>
                            <button class="btn btn-red btn-sm" onclick="deleteProduct('${p.id}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderDashboard() {
            // å®‰å…¨ãªãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
            const totalProductsEl = document.getElementById('total-products');
            const totalPackagesEl = document.getElementById('total-packages');
            const totalMaterialsEl = document.getElementById('total-materials');
            const totalIngredientsEl = document.getElementById('total-ingredients');
            
            if (totalProductsEl) totalProductsEl.textContent = products.length;
            if (totalPackagesEl) totalPackagesEl.textContent = packages.length;
            if (totalMaterialsEl) totalMaterialsEl.textContent = materials.filter(m => m.status === 'active').length;
            if (totalIngredientsEl) totalIngredientsEl.textContent = ingredients.length;
            
            const tb = document.getElementById('dashboard-table-body');
            if (!tb) return;
            tb.innerHTML = '';
            
            // â˜…å¤‰æ›´: å•†å“ã‚’è¡¨ç¤º
            if (packages.length === 0) {
                tb.innerHTML = '<tr><td colspan="7" class="text-center text-gray">å•†å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
                return;
            }
            
            packages.forEach(pkg => {
                const cost = calculatePackageCost(pkg.id);
                const totalProducts = pkg.contents ? pkg.contents.filter(c => c.type === 'product').reduce((sum, item) => sum + item.quantity, 0) : 0;
                const contentSummary = totalProducts > 0 ? `${totalProducts}å€‹å…¥ã‚Š` : 'æœªè¨­å®š';
                
                const costDisplay = cost > 0 ? 
                    `<span class="font-bold text-green">${fmt(cost)}</span>` : 
                    `<span class="text-gray">â€”</span>`;
                
                // è²©å£²ä¾¡æ ¼ã¨ç²—åˆ©ç‡
                let priceDisplay = '<span class="text-gray">â€”</span>';
                let marginDisplay = '<span class="text-gray">â€”</span>';
                
                if (pkg.pricing && pkg.pricing.sellingPrice > 0) {
                    priceDisplay = `<span class="font-bold">${fmt(pkg.pricing.sellingPrice)}</span>`;
                    if (cost > 0) {
                        const grossProfit = pkg.pricing.sellingPrice - cost;
                        const marginRate = (grossProfit / pkg.pricing.sellingPrice * 100).toFixed(1);
                        const marginColor = marginRate >= 50 ? 'text-green' : marginRate >= 30 ? 'text-orange' : 'text-red';
                        marginDisplay = `<span class="font-bold ${marginColor}">${marginRate}%</span>`;
                    }
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <span class="clickable-product" onclick="showPackageDetail('${pkg.id}')">${esc(pkg.name)}</span>
                    </td>
                    <td class="text-sm text-gray">${esc(pkg.sku)}</td>
                    <td class="text-sm">${contentSummary}</td>
                    <td class="text-right">${costDisplay}</td>
                    <td class="text-right">${priceDisplay}</td>
                    <td class="text-right">${marginDisplay}</td>
                    <td class="text-center">
                        <button class="btn btn-purple btn-sm" onclick="editPackage('${pkg.id}')">ç·¨é›†</button>
                        <button class="btn btn-red btn-sm" onclick="deletePackage('${pkg.id}')">å‰Šé™¤</button>
                    </td>
                `;
                tb.appendChild(tr);
            });
        }

        function renderMaterials() {
            const tb = document.getElementById('materials-master-table');
            if (!tb) return;
            tb.innerHTML = '';
            
            const displayMaterials = showSuspendedMaterials 
                ? materials 
                : materials.filter(m => m.status !== 'suspended');
            
            if (displayMaterials.length === 0) { 
                tb.innerHTML = '<tr><td colspan="7" class="text-center text-gray" style="padding:20px;">ææ–™ãƒã‚¹ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>'; 
                return; 
            }
            
            displayMaterials.forEach(m => {
                const isSuspended = m.status === 'suspended';
                const rowClass = isSuspended ? 'row-suspended' : '';
                const tr = document.createElement('tr');
                tr.className = rowClass;
                
                const statusBadge = isSuspended 
                    ? '<span class="badge badge-gray">ä¿ç•™</span>' 
                    : '<span class="badge badge-green">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span>';
                
                const actionButtons = isSuspended
                    ? `<button class="btn btn-green btn-sm" onclick="activateMaterial('${m.id}')">å†é–‹</button>
                       <button class="btn btn-red btn-sm" onclick="deleteMaterial('${m.id}')">å‰Šé™¤</button>`
                    : `<button class="btn btn-gray btn-sm" onclick="suspendMaterial('${m.id}')">ä¿ç•™</button>
                       <button class="btn btn-red btn-sm" onclick="deleteMaterial('${m.id}')">å‰Šé™¤</button>`;
                
                tr.innerHTML = `<td><input type="text" class="table-input" value="${esc(m.name || '')}" placeholder="ææ–™å" onchange="updateMaterial('${m.id}', 'name', this.value)" ${isSuspended ? 'disabled' : ''}></td><td><input type="text" class="table-input" value="${esc(m.code || '')}" placeholder="CODE" maxlength="6" style="text-transform:uppercase;" onchange="updateMaterial('${m.id}', 'code', this.value.toUpperCase())" ${isSuspended ? 'disabled' : ''}></td><td><input type="text" class="table-input" value="${esc(m.category || '')}" placeholder="ä¾‹: ç²‰é¡" onchange="updateMaterial('${m.id}', 'category', this.value)" ${isSuspended ? 'disabled' : ''}></td><td><input type="text" class="table-input" value="${esc(m.productName || '')}" placeholder="ä¾‹: æ—¥æ¸…ã‚«ãƒ¡ãƒªãƒ¤" onchange="updateMaterial('${m.id}', 'productName', this.value)" ${isSuspended ? 'disabled' : ''}></td><td><select class="table-input" onchange="updateMaterial('${m.id}', 'type', this.value)" ${isSuspended ? 'disabled' : ''}><option value="material" ${m.type === 'material' ? 'selected' : ''}>åŸææ–™</option><option value="packaging" ${m.type === 'packaging' ? 'selected' : ''}>åŒ…æ</option></select></td><td class="text-center">${statusBadge}</td><td><div class="flex gap-2">${actionButtons}</div></td>`;
                tb.appendChild(tr);
            });
        }

        function renderIngredients() {
            const tb = document.getElementById('ingredients-table');
            const noi = document.getElementById('no-ingredients');
            if (!tb || !noi) return;
            
            if (ingredients.length === 0) { 
                tb.innerHTML = ''; 
                noi.classList.remove('hidden'); 
                return; 
            }
            noi.classList.add('hidden');
            tb.innerHTML = '';
            
            const activeMaterials = materials.filter(m => m.status === 'active');
            
            ingredients.forEach(ing => {
                const m = materials.find(mat => mat.id === ing.material_id);
                const up = ing.qty > 0 ? ing.price / ing.qty : 0;
                const tl = m?.type === 'packaging' ? '[åŒ…æ]' : '[åŸææ–™]';
                
                let expiryHtml = '';
                if (ing.expiry) {
                    const today = new Date();
                    const expiry = new Date(ing.expiry);
                    const daysUntil = Math.floor((expiry - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntil < 0) {
                        expiryHtml = `<input type="date" class="table-input expiry-warning" value="${ing.expiry}" onchange="updateIngredient('${ing.id}', 'expiry', this.value)">`;
                    } else if (daysUntil <= 30) {
                        expiryHtml = `<input type="date" class="table-input expiry-warning" value="${ing.expiry}" onchange="updateIngredient('${ing.id}', 'expiry', this.value)">`;
                    } else if (daysUntil <= 60) {
                        expiryHtml = `<input type="date" class="table-input expiry-caution" value="${ing.expiry}" onchange="updateIngredient('${ing.id}', 'expiry', this.value)">`;
                    } else {
                        expiryHtml = `<input type="date" class="table-input" value="${ing.expiry}" onchange="updateIngredient('${ing.id}', 'expiry', this.value)">`;
                    }
                } else {
                    expiryHtml = `<input type="date" class="table-input" value="" onchange="updateIngredient('${ing.id}', 'expiry', this.value)">`;
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${tl}<select class="table-input" onchange="updateIngredient('${ing.id}', 'material_id', this.value)">${activeMaterials.map(mat => `<option value="${mat.id}" ${mat.id === ing.material_id ? 'selected' : ''}>${esc(mat.name)} (${esc(mat.code)})</option>`).join('')}</select></td><td><span class="badge badge-blue font-mono">${esc(ing.lot_no || 'è‡ªå‹•ç”Ÿæˆ')}</span></td><td><input type="date" class="table-input" value="${ing.date}" onchange="updateIngredient('${ing.id}', 'date', this.value)"></td><td><input type="number" class="table-input" value="${ing.qty}" min="0" step="0.01" onchange="updateIngredient('${ing.id}', 'qty', this.value)"></td><td><select class="table-input" onchange="updateIngredient('${ing.id}', 'unit', this.value)"><option value="g" ${ing.unit === 'g' ? 'selected' : ''}>g</option><option value="kg" ${ing.unit === 'kg' ? 'selected' : ''}>kg</option><option value="mL" ${ing.unit === 'mL' ? 'selected' : ''}>mL</option><option value="L" ${ing.unit === 'L' ? 'selected' : ''}>L</option><option value="å€‹" ${ing.unit === 'å€‹' ? 'selected' : ''}>å€‹</option><option value="æš" ${ing.unit === 'æš' ? 'selected' : ''}>æš</option></select></td><td><input type="number" class="table-input" value="${ing.price}" min="0" step="0.01" onchange="updateIngredient('${ing.id}', 'price', this.value)"></td><td class="text-right"><span class="unit-price">${fmtDec(up)}/${esc(ing.unit)}</span></td><td><input type="text" class="table-input" value="${esc(ing.supplier)}" onchange="updateIngredient('${ing.id}', 'supplier', this.value)"></td><td>${expiryHtml}</td><td><div class="flex gap-2"><button class="btn btn-yellow btn-sm" onclick="markAsUsedUp('${ing.id}')">ä½¿ã„åˆ‡ã‚Š</button><button class="btn btn-red btn-sm" onclick="deleteIngredient('${ing.id}')">å‰Šé™¤</button></div></td>`;
                tb.appendChild(tr);
            });
        }

        function renderUsedUp() {
            const tb = document.getElementById('used-up-table');
            const nou = document.getElementById('no-used-up');
            if (!tb || !nou) return;
            
            if (usedUpIngredients.length === 0) { 
                tb.innerHTML = ''; 
                nou.classList.remove('hidden'); 
                return; 
            }
            
            nou.classList.add('hidden');
            tb.innerHTML = '';
            
            usedUpIngredients.forEach(ing => {
                const m = materials.find(mat => mat.id === ing.material_id);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${m ? esc(m.name) : 'ä¸æ˜'}</td><td><span class="badge badge-gray font-mono">${esc(ing.lot_no || '-')}</span></td><td>${ing.date}</td><td>${ing.qty} ${esc(ing.unit)}</td><td>${esc(ing.unit)}</td><td>${fmt(ing.price)}</td><td>${esc(ing.supplier)}</td><td>${ing.used_up_date || '-'}</td><td><div class="flex gap-2"><button class="btn btn-primary btn-sm" onclick="restoreFromUsedUp('${ing.id}')">å¾©å…ƒ</button><button class="btn btn-red btn-sm" onclick="deleteUsedUp('${ing.id}')">å‰Šé™¤</button></div></td>`;
                tb.appendChild(tr);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            initData();
            renderAll();
            // API_BASEãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿S3ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            loadLatestFromCloud();
            const imp = document.getElementById('import-file');
            if (imp) imp.addEventListener('change', importData);
        });
    </script>
</body>
</html>