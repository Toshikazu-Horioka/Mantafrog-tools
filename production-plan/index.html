<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ³å£å³¶ã‚¯ãƒƒã‚­ãƒ¼å±‹ ç”Ÿç”£è¨ˆç”»ã‚·ã‚¹ãƒ†ãƒ  v2.1</title>
    <style>
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background-color: #f8fafc; color: #334155; font-size: 16px; }
.container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
.header { background: linear-gradient(135deg, #475569 0%, #334155 100%); color: white; padding: 32px; text-align: center; }
.header h1 { margin: 0 0 8px 0; font-size: 32px; font-weight: 600; }
.header p { margin: 0; opacity: 0.9; font-size: 18px; }
.section { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; margin: 24px; overflow: hidden; }
.section h2 { background: #f1f5f9; margin: 0; padding: 16px 20px; font-size: 20px; font-weight: 600; color: #475569; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
.section-content { padding: 20px; }
.collapsible { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; margin: 16px 24px; overflow: hidden; }
.collapsible-header { background: #475569; color: white; padding: 16px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500; transition: background-color 0.2s; font-size: 16px; }
.collapsible-header:hover { background: #334155; }
.collapsible-content { padding: 20px; background: #ffffff; display: none; }
.collapsible-content.open { display: block; }
.toggle-icon { font-size: 18px; transition: transform 0.2s; }
.toggle-icon.rotated { transform: rotate(180deg); }
.compact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 16px 0; }
.form-group { margin-bottom: 16px; }
label { display: block; margin-bottom: 6px; font-weight: 500; color: #475569; font-size: 15px; }
input, select, textarea { width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 15px; box-sizing: border-box; transition: border-color 0.2s; }
input:focus, select:focus, textarea:focus { outline: none; border-color: #475569; box-shadow: 0 0 0 3px rgba(71, 85, 105, 0.15); }
textarea { resize: vertical; min-height: 80px; font-family: inherit; }
.btn { background: #475569; color: #ffffff; border: none; padding: 12px 18px; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500; margin: 4px; transition: background-color 0.2s; }
.btn:hover { background: #334155; }
.btn-small { padding: 8px 14px; font-size: 14px; }
.btn-danger { background: #991b1b; }
.btn-danger:hover { background: #7f1d1d; }
.btn-success { background: #14532d; }
.btn-success:hover { background: #052e16; }
.btn-warning { background: #a16207; }
.btn-warning:hover { background: #78350f; }
.table { width: 100%; border-collapse: collapse; margin: 0; }
.table th, .table td { padding: 14px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 15px; }
.table th { background: #f8fafc; color: #475569; font-weight: 600; font-size: 15px; }
.result-box { background: #e2e8f0; padding: 18px; border-radius: 6px; margin: 16px 0; border-left: 4px solid #475569; }
.alert { padding: 18px; border-radius: 6px; margin: 16px 0; font-size: 15px; }
.alert-success { background: #f0fdf4; color: #14532d; border: 1px solid #bbf7d0; }
.alert-warning { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }
.current-status { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin: 0; }
.status-card { background: #ffffff !important; border: 1px solid #e2e8f0 !important; border-radius: 8px; padding: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.04); text-align: center; color: #1e293b !important; }
.status-number { font-size: 42px; font-weight: 700; color: #475569; }
.status-label { color: #64748b; font-size: 15px; }
.production-emergency { border: 3px solid #991b1b !important; }
.production-emergency .status-number { color: #991b1b; }
.card { background: white; padding: 24px; margin: 16px 0; border-radius: 12px; border: 1px solid #e2e8f0; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #f1f5f9; }
.card-title { font-size: 20px; font-weight: 600; color: #1e293b; }
.bulk-order-form { background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
.product-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin: 16px 0; }
.product-item { background: white; padding: 18px; border-radius: 8px; border: 1px solid #e2e8f0; }
.product-checkbox { margin: 0; transform: scale(1.3); }
.same-date-section { background: #eff6ff; padding: 18px; border-radius: 8px; margin: 16px 0; border: 1px solid #bfdbfe; }
.order-summary { background: white; padding: 18px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 16px; font-size: 15px; }
.client-name { font-size: 20px; font-weight: 600; color: #1e293b; }
.product-item input[type="checkbox"] { width: auto; }
.ingredient-list { background: #f8fafc; padding: 16px; border-radius: 6px; margin-top: 12px; }
.ingredient-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; margin: 6px 0; border-radius: 4px; border: 1px solid #e2e8f0; }
.add-ingredient-section { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; margin-top: 12px; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
.modal.show { display: block; }
.modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #e2e8f0; }
.modal-header h3 { margin: 0; font-size: 22px; color: #1e293b; }
.modal-close { color: #94a3b8; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 1; transition: color 0.2s; }
.modal-close:hover { color: #475569; }
.modal-body { margin-bottom: 20px; max-height: 70vh; overflow-y: auto; }
.modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding-top: 16px; border-top: 1px solid #e2e8f0; }
.info-box { background: #eff6ff; padding: 16px; border-radius: 6px; margin: 16px 0; border-left: 4px solid #3b82f6; }
.info-box h4 { margin: 0 0 8px 0; color: #1e40af; font-size: 16px; }
.info-box p { margin: 4px 0; font-size: 14px; color: #1e40af; }
.data-management-section { background: #f8fafc; padding: 24px; border-radius: 8px; margin: 24px; border: 2px solid #e2e8f0; }
.data-management-section h3 { margin: 0 0 16px 0; font-size: 20px; color: #334155; }
.data-management-buttons { display: flex; gap: 12px; flex-wrap: wrap; }
.oven-card { background: white; padding: 20px; margin: 12px 0; border-radius: 8px; border: 1px solid #e2e8f0; }
.oven-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #f1f5f9; }
.oven-name-input { border: none; background: transparent; font-size: 18px; font-weight: 600; color: #334155; width: 250px; padding: 4px 8px; border-radius: 4px; }
.oven-name-input:hover { background: #f8fafc; }
.oven-name-input:focus { border: 1px solid #475569; background: white; outline: none; }
.oven-settings-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.oven-capacity { background: #e2e8f0; padding: 12px; border-radius: 6px; margin-top: 12px; text-align: center; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸï¸ çŸ³å£å³¶ã‚¯ãƒƒã‚­ãƒ¼å±‹ ç”Ÿç”£è¨ˆç”»ã‚·ã‚¹ãƒ†ãƒ  v2.1</h1>
            <p>è£½å“ãƒ»å•†å“ãƒã‚¹ã‚¿ç®¡ç†å¯¾å¿œç‰ˆ</p>
        </div>

        <!-- ã‚·ã‚¹ãƒ†ãƒ èª¬æ˜ -->
        <div class="info-box" style="margin: 24px;">
            <h4>ğŸ“– ã‚·ã‚¹ãƒ†ãƒ ã®ä½¿ã„æ–¹</h4>
            <p><strong>1. ãƒã‚¹ã‚¿ç®¡ç†:</strong> è£½å“ï¼ˆã‚¯ãƒƒã‚­ãƒ¼å˜å“ï¼‰ã¨å•†å“ï¼ˆè¢‹è©°ã‚è£½å“ï¼‰ã‚’ç™»éŒ²ãƒ»ç®¡ç†ã—ã¾ã™ã€‚å•†å“ã¯è¤‡æ•°ã®è£½å“ã‚’çµ„ã¿åˆã‚ã›ã¦ä½œæˆã§ãã¾ã™ã€‚</p>
            <p><strong>2. å¤§å£æ³¨æ–‡:</strong> ãƒ›ãƒ†ãƒ«ã‚„ä¼æ¥­ã‹ã‚‰ã®å¤§é‡æ³¨æ–‡ã‚’ç™»éŒ²ã—ã¾ã™ã€‚ç´æœŸã‚„å‚™è€ƒã‚‚è¨˜éŒ²ã§ãã¾ã™ã€‚</p>
            <p><strong>3. ç”Ÿç”£è¨ˆç”»:</strong> éœ€è¦äºˆæ¸¬ã¨å¤§å£æ³¨æ–‡ã‹ã‚‰ã€é€±æ¬¡ã®ç”Ÿç”£è¨ˆç”»ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚</p>
            <p><strong>4. è£½å“åˆ¥ç”Ÿç”£:</strong> å•†å“ã‚’è£½å“ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ï¼‰å˜ä½ã«åˆ†è§£ã—ã€å®Ÿéš›ã«ç„¼ãã¹ãã‚¯ãƒƒã‚­ãƒ¼ã®æ•°é‡ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
        </div>

        <!-- ä»Šæ—¥ã®ç”Ÿç”£æŒ‡ç¤ºï¼ˆè£½å“ãƒ™ãƒ¼ã‚¹ï¼‰ -->
        <div class="section">
            <h2>
                ğŸ¯ ä»Šæ—¥ã®ç”Ÿç”£æŒ‡ç¤ºï¼ˆè£½å“åˆ¥ï¼‰
                <button class="btn btn-small" onclick="toggleWeeklyPlan()" style="background: #475569;">
                    ğŸ“‹ é€±æ¬¡ç”Ÿç”£è¨ˆç”»ã‚’è¡¨ç¤º
                </button>
            </h2>
            <div class="section-content">
                <div id="todayProduction" class="current-status">
                    <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>

        <!-- é€±æ¬¡ç”Ÿç”£è¨ˆç”»ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
        <div class="collapsible" id="weeklyPlanCollapsible" style="display: none;">
            <div class="collapsible-header" onclick="toggleCollapsible('weeklyPlan')">
                <span>ğŸ“‹ é€±æ¬¡ç”Ÿç”£è¨ˆç”»ï¼ˆå•†å“åˆ¥ï¼‰</span>
                <span class="toggle-icon" id="weeklyPlan-icon">â–¼</span>
            </div>
            <div class="collapsible-content open" id="weeklyPlan-content">
                <table class="table">
                    <thead>
                        <tr>
                            <th>å•†å“å</th>
                            <th>ç¾åœ¨åœ¨åº«</th>
                            <th>åŸºæº–éœ€è¦</th>
                            <th>éœ€è¦äºˆæ¸¬</th>
                            <th>å¤§å£æ³¨æ–‡</th>
                            <th>åˆè¨ˆéœ€è¦</th>
                            <th>ç”Ÿç”£è¨ˆç”»</th>
                            <th>é€±æœ«äºˆå®šåœ¨åº«</th>
                        </tr>
                    </thead>
                    <tbody id="planTableBody">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                    </tbody>
                </table>
                <button class="btn btn-success" onclick="toggleCookieProduction()" style="margin-top: 16px;">
                    ğŸª è£½å“åˆ¥ç”Ÿç”£å¿…è¦æ•°ã‚’è¡¨ç¤º
                </button>
            </div>
        </div>

        <!-- è£½å“åˆ¥ç”Ÿç”£å¿…è¦æ•°ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
        <div class="collapsible" id="cookieProductionCollapsible" style="display: none;">
            <div class="collapsible-header" onclick="toggleCollapsible('cookieProduction')">
                <span>ğŸª è£½å“åˆ¥ç”Ÿç”£å¿…è¦æ•°ï¼ˆã‚¯ãƒƒã‚­ãƒ¼å˜ä½ï¼‰</span>
                <span class="toggle-icon" id="cookieProduction-icon">â–¼</span>
            </div>
            <div class="collapsible-content open" id="cookieProduction-content">
                <table class="table">
                    <thead>
                        <tr>
                            <th>è£½å“åï¼ˆã‚¯ãƒƒã‚­ãƒ¼ï¼‰</th>
                            <th>ä»Šé€±å¿…è¦æ•°</th>
                            <th>å†…è¨³</th>
                        </tr>
                    </thead>
                    <tbody id="cookieProductionTableBody">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ãƒã‚¹ã‚¿ç®¡ç† -->
        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible('masterData')">
                <span>ğŸ“š ãƒã‚¹ã‚¿ç®¡ç†ï¼ˆè£½å“ãƒ»å•†å“ï¼‰</span>
                <span class="toggle-icon" id="masterData-icon">â–¼</span>
            </div>
            <div class="collapsible-content" id="masterData-content">
                
                <!-- è£½å“ãƒã‚¹ã‚¿ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ãã®ã‚‚ã®ï¼‰ -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('cookieMaster')">
                        <span>ğŸª è£½å“ãƒã‚¹ã‚¿ï¼ˆã‚¯ãƒƒã‚­ãƒ¼å€‹åˆ¥ï¼‰</span>
                        <span class="toggle-icon" id="cookieMaster-icon">â–¼</span>
                    </div>
                    <div class="collapsible-content" id="cookieMaster-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <p style="margin: 0; color: #64748b;">ã‚¯ãƒƒã‚­ãƒ¼å˜å“ï¼ˆãƒãƒ‹ãƒ©ã‚¯ãƒƒã‚­ãƒ¼ã€ãƒãƒ§ã‚³ã‚¯ãƒƒã‚­ãƒ¼ãªã©ï¼‰ã‚’ç®¡ç†ã—ã¾ã™</p>
                            <button class="btn btn-small btn-success" onclick="openAddCookieModal()">+ æ–°è¦è£½å“è¿½åŠ </button>
                        </div>
                        <div id="cookieList"></div>
                    </div>
                </div>

                <!-- å•†å“ãƒã‚¹ã‚¿ï¼ˆè¢‹è©°ã‚è£½å“ï¼‰ -->
                <div class="collapsible" style="margin-top: 16px;">
                    <div class="collapsible-header" onclick="toggleCollapsible('productMaster')">
                        <span>ğŸ“¦ å•†å“ãƒã‚¹ã‚¿ï¼ˆè¢‹è©°ã‚è£½å“ï¼‰</span>
                        <span class="toggle-icon" id="productMaster-icon">â–¼</span>
                    </div>
                    <div class="collapsible-content" id="productMaster-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <p style="margin: 0; color: #64748b;">è¤‡æ•°ã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’çµ„ã¿åˆã‚ã›ãŸè¢‹è©°ã‚è£½å“ã‚’ç®¡ç†ã—ã¾ã™</p>
                            <button class="btn btn-small btn-success" onclick="openAddProductModal()">+ æ–°è¦å•†å“è¿½åŠ </button>
                        </div>
                        <div id="productList"></div>
                    </div>
                </div>

            </div>
        </div>

        <!-- å¤§å£æ³¨æ–‡ç®¡ç† -->
        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible('bulkOrders')">
                <span>ğŸ“¦ å¤§å£æ³¨æ–‡ç®¡ç†</span>
                <span class="toggle-icon" id="bulkOrders-icon">â–¼</span>
            </div>
            <div class="collapsible-content" id="bulkOrders-content">
                <div>
                    <h4>å¤§å£æ³¨æ–‡ç™»éŒ²</h4>
                    <p style="color: #64748b;">ãƒ›ãƒ†ãƒ«ãƒ»ä¼æ¥­ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã‹ã‚‰ã®å¤§é‡æ³¨æ–‡ã‚’ç™»éŒ²ã—ã¾ã™</p>
                    <div class="bulk-order-form">
                        <h5 style="margin-top: 0; color: #475569;">æ–°è¦å¤§å£æ³¨æ–‡</h5>
                        
                        <!-- åŸºæœ¬æƒ…å ± -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="clientName">ç´å“å…ˆå:</label>
                                <input type="text" id="clientName" placeholder="ãƒ›ãƒ†ãƒ«ãƒ»ä¼æ¥­ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆåãªã©">
                            </div>
                            <div class="form-group">
                                <label for="orderNote">å‚™è€ƒ:</label>
                                <textarea id="orderNote" placeholder="ç”¨é€”ãƒ»é€£çµ¡å…ˆãƒ»ç‰¹è¨˜äº‹é …ãªã©" rows="3"></textarea>
                            </div>
                        </div>

                        <!-- åŒä¸€ç´æœŸè¨­å®š -->
                        <div class="same-date-section">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <input type="checkbox" id="sameDateForAll" onchange="toggleSameDateMode()">
                                <label for="sameDateForAll" style="margin: 0; font-weight: 600;">ã™ã¹ã¦åŒã˜ç´æœŸã§è¨­å®š</label>
                            </div>
                            <div id="commonDateInput" style="display: none;">
                                <label for="commonDeliveryDate">å…±é€šç´æœŸ:</label>
                                <input type="date" id="commonDeliveryDate" onchange="applyCommonDate()">
                            </div>
                        </div>

                        <!-- å•†å“é¸æŠ -->
                        <h6 style="margin: 16px 0 8px 0; color: #475569;">å•†å“é¸æŠã¨æ•°é‡ãƒ»ç´æœŸ</h6>
                        <div class="product-selection" id="productSelection">
                            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                        </div>

                        <!-- æ³¨æ–‡ç¢ºèªãƒ»ç™»éŒ² -->
                        <div class="order-summary">
                            <h6 style="margin-top: 0; color: #475569;">æ³¨æ–‡å†…å®¹ç¢ºèª</h6>
                            <div id="orderSummary">
                                å•†å“ã‚’é¸æŠã™ã‚‹ã¨å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                            </div>
                            <button class="btn" onclick="addBulkOrder()" style="margin-top: 16px; width: 100%;">
                                ğŸ“¦ å¤§å£æ³¨æ–‡ã‚’ç™»éŒ²
                            </button>
                        </div>
                    </div>
                    
                    <h5>ç™»éŒ²æ¸ˆã¿å¤§å£æ³¨æ–‡</h5>
                    <div id="bulkOrdersList">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- éœ€è¦äºˆæ¸¬è¨­å®š -->
        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible('demandSettings')">
                <span>ğŸŒ¤ï¸ éœ€è¦äºˆæ¸¬è¨­å®š</span>
                <span class="toggle-icon" id="demandSettings-icon">â–¼</span>
            </div>
            <div class="collapsible-content" id="demandSettings-content">
                <p style="color: #64748b;">å¤©æ°—ãƒ»å­£ç¯€ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒ»è¦³å…‰å®¢çŠ¶æ³ã‹ã‚‰éœ€è¦ã‚’äºˆæ¸¬ã—ã¾ã™</p>
                <div class="compact-grid">
                    <div class="form-group">
                        <label for="weather">å¤©æ°—äºˆå ±:</label>
                        <select id="weather" onchange="updateForecast()">
                            <option value="1.05">æ™´ã‚Œ (+5%)</option>
                            <option value="1.0" selected>æ›‡ã‚Š (Â±0%)</option>
                            <option value="0.9">é›¨äºˆå ± (-10%)</option>
                            <option value="0.75">å°é¢¨æ¥è¿‘ (-25%)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="season">å­£ç¯€è¦å› :</label>
                        <select id="season" onchange="updateForecast()">
                            <option value="1.2">è¶…è¦³å…‰ã‚·ãƒ¼ã‚ºãƒ³ (+20%)</option>
                            <option value="1.15" selected>è¦³å…‰ã‚·ãƒ¼ã‚ºãƒ³ (+15%)</option>
                            <option value="1.0">é€šå¸¸æœŸ (Â±0%)</option>
                            <option value="0.85">ã‚„ã‚„é–‘æ•£æœŸ (-15%)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="event">ã‚¤ãƒ™ãƒ³ãƒˆ:</label>
                        <select id="event" onchange="updateForecast()">
                            <option value="1.2">å¤§å‹ã‚¤ãƒ™ãƒ³ãƒˆ (+20%)</option>
                            <option value="1.15">ä¸­å‹ã‚¤ãƒ™ãƒ³ãƒˆ (+15%)</option>
                            <option value="1.05">å°å‹ã‚¤ãƒ™ãƒ³ãƒˆ (+5%)</option>
                            <option value="1.0" selected>é€šå¸¸å–¶æ¥­ (Â±0%)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tourist">è¦³å…‰å®¢çŠ¶æ³:</label>
                        <select id="tourist" onchange="updateForecast()">
                            <option value="1.15">æº€å“¡ (+15%)</option>
                            <option value="1.05" selected>ã‚„ã‚„å¤šã‚ (+5%)</option>
                            <option value="1.0">é€šå¸¸ (Â±0%)</option>
                            <option value="0.95">ã‚„ã‚„å°‘ãªã‚ (-5%)</option>
                        </select>
                    </div>
                </div>
                
                <div class="result-box">
                    <h4>ğŸ“ˆ éœ€è¦ä¿‚æ•°è¨ˆç®—</h4>
                    <p>
                        å¤©æ°—: <span id="weatherFactor">1.00</span> Ã— 
                        å­£ç¯€: <span id="seasonFactor">1.15</span> Ã— 
                        ã‚¤ãƒ™ãƒ³ãƒˆ: <span id="eventFactor">1.00</span> Ã— 
                        è¦³å…‰å®¢: <span id="touristFactor">1.05</span> = 
                        <strong id="totalFactor">1.21</strong>
                    </p>
                    <p>éœ€è¦äºˆæ¸¬ã¸ã®å½±éŸ¿: <strong id="demandImpact">+21%</strong></p>
                </div>
            </div>
        </div>

        <!-- ä¾›çµ¦ç®¡ç† -->
        <div class="collapsible">
            <div class="collapsible-header" onclick="toggleCollapsible('supplySettings')">
                <span>âš™ï¸ ä¾›çµ¦ç®¡ç†ï¼ˆã‚ªãƒ¼ãƒ–ãƒ³ãƒ»ã‚·ãƒ•ãƒˆï¼‰</span>
                <span class="toggle-icon" id="supplySettings-icon">â–¼</span>
            </div>
            <div class="collapsible-content" id="supplySettings-content">
                
                <!-- ã‚ªãƒ¼ãƒ–ãƒ³è¨­å®š -->
                <h4>ğŸ”¥ ã‚ªãƒ¼ãƒ–ãƒ³è¨­å®š</h4>
                <p style="color: #64748b;">å„ã‚ªãƒ¼ãƒ–ãƒ³ã®è¨­å®šã‚’å€‹åˆ¥ã«ç®¡ç†ã—ã¾ã™</p>
                
                <div style="margin-bottom: 16px;">
                    <button class="btn btn-small btn-success" onclick="addOven()">+ ã‚ªãƒ¼ãƒ–ãƒ³è¿½åŠ </button>
                </div>
                
                <div id="ovensList">
                    <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
                
                <div class="result-box" style="margin-top: 20px;">
                    <h4>ğŸ“Š ç·ç”Ÿç”£èƒ½åŠ›è¨ˆç®—</h4>
                    <p>
                        å…¨ã‚ªãƒ¼ãƒ–ãƒ³åˆè¨ˆ<br>
                        1æ—¥æœ€å¤§ç„¼æˆå›æ•°: <strong id="totalMaxBatches">0</strong>å›<br>
                        1æ—¥æœ€å¤§ç”Ÿç”£èƒ½åŠ›: <strong id="totalMaxCapacity">0</strong>å€‹
                    </p>
                </div>

                <!-- ã‚·ãƒ•ãƒˆè¨­å®š -->
                <h4 style="margin-top: 32px;">ğŸ‘¥ ã‚·ãƒ•ãƒˆãƒ»é‡ã¿ä»˜ã‘è¨­å®š</h4>
                <p style="color: #64748b;">å„æ›œæ—¥ã®ç”Ÿç”£é‡ã¿ã‚’è¨­å®šï¼ˆ1.0=é€šå¸¸ã€0.5=åŠåˆ†ã€1.5=1.5å€ï¼‰</p>
                <div class="compact-grid">
                    <div class="form-group">
                        <label for="mondayWeight">æœˆæ›œæ—¥:</label>
                        <input type="number" id="mondayWeight" value="1.0" min="0" max="2" step="0.1" onchange="updateShiftWeight(0, this.value)">
                    </div>
                    <div class="form-group">
                        <label for="tuesdayWeight">ç«æ›œæ—¥:</label>
                        <input type="number" id="tuesdayWeight" value="1.0" min="0" max="2" step="0.1" onchange="updateShiftWeight(1, this.value)">
                    </div>
                    <div class="form-group">
                        <label for="wednesdayWeight">æ°´æ›œæ—¥:</label>
                        <input type="number" id="wednesdayWeight" value="1.0" min="0" max="2" step="0.1" onchange="updateShiftWeight(2, this.value)">
                    </div>
                    <div class="form-group">
                        <label for="thursdayWeight">æœ¨æ›œæ—¥:</label>
                        <input type="number" id="thursdayWeight" value="1.0" min="0" max="2" step="0.1" onchange="updateShiftWeight(3, this.value)">
                    </div>
                    <div class="form-group">
                        <label for="fridayWeight">é‡‘æ›œæ—¥:</label>
                        <input type="number" id="fridayWeight" value="1.0" min="0" max="2" step="0.1" onchange="updateShiftWeight(4, this.value)">
                    </div>
                    <div class="form-group">
                        <label for="saturdayWeight">åœŸæ›œæ—¥:</label>
                        <input type="number" id="saturdayWeight" value="1.0" min="0" max="2" step="0.1" onchange="updateShiftWeight(5, this.value)">
                    </div>
                </div>
                
                <div class="result-box">
                    <h4>ãƒ—ãƒªã‚»ãƒƒãƒˆ</h4>
                    <button class="btn btn-small" onclick="setShiftPreset('normal')">é€šå¸¸ã‚·ãƒ•ãƒˆ (å…¨ã¦1.0)</button>
                    <button class="btn btn-small" onclick="setShiftPreset('weekend')">é€±æœ«å¼·åŒ– (é‡‘åœŸ1.5å€)</button>
                    <button class="btn btn-small" onclick="setShiftPreset('midweek')">å¹³æ—¥é›†ä¸­ (ç«æ°´æœ¨1.3å€)</button>
                </div>

            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="data-management-section">
            <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿</h3>
            <p style="color: #64748b; margin-bottom: 16px;">ã™ã¹ã¦ã®ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã€æ³¨æ–‡æƒ…å ±ã€è¨­å®šã‚’ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ã§ãã¾ã™</p>
            <div class="data-management-buttons">
                <button class="btn btn-success" onclick="exportAllData()">
                    ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆJSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
                </button>
                <label class="btn" style="background: #14532d; cursor: pointer;">
                    ğŸ“ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼‰
                    <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                </label>
                <button class="btn btn-warning" onclick="updateAll()">
                    ğŸ”„ è¨ˆç”»ã‚’å†è¨ˆç®—
                </button>
            </div>
        </div>

    </div>

    <!-- è£½å“è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="addCookieModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°è¦è£½å“ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ï¼‰è¿½åŠ </h3>
                <span class="modal-close" onclick="closeAddCookieModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newCookieName">è£½å“å:</label>
                    <input type="text" id="newCookieName" placeholder="ä¾‹: ãƒãƒ‹ãƒ©ã‚¯ãƒƒã‚­ãƒ¼">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAddCookieModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-success" onclick="addCookie()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <!-- å•†å“è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">æ–°è¦å•†å“ï¼ˆè¢‹è©°ã‚è£½å“ï¼‰è¿½åŠ </h3>
                <span class="modal-close" onclick="closeAddProductModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newProductName">å•†å“å:</label>
                    <input type="text" id="newProductName" placeholder="ä¾‹: ãƒãƒ‹ãƒ©ã‚¯ãƒƒã‚­ãƒ¼12å€‹å…¥ã‚Š">
                </div>
                <div class="form-group">
                    <label for="newProductBaseDemand">åŸºæº–éœ€è¦ï¼ˆè¢‹/é€±ï¼‰:</label>
                    <input type="number" id="newProductBaseDemand" value="10" min="1">
                </div>
                <div class="form-group">
                    <label for="newProductStock">ç¾åœ¨åœ¨åº«ï¼ˆè¢‹ï¼‰:</label>
                    <input type="number" id="newProductStock" value="0" min="0">
                </div>
                <div class="form-group">
                    <label for="newProductSafetyStock">å®‰å…¨åœ¨åº«ï¼ˆè¢‹ï¼‰:</label>
                    <input type="number" id="newProductSafetyStock" value="5" min="0">
                </div>
                <div class="form-group">
                    <label>å«ã¾ã‚Œã‚‹è£½å“ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ï¼‰:</label>
                    <div class="ingredient-list" id="newProductIngredients">
                        <p style="color: #64748b; font-style: italic;">è£½å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                    </div>
                    <div class="add-ingredient-section">
                        <select id="ingredientCookieSelect">
                            <option value="">è£½å“ã‚’é¸æŠ...</option>
                        </select>
                        <input type="number" id="ingredientQuantity" placeholder="å€‹æ•°" min="1" value="1" style="width: 100px;">
                        <button class="btn btn-small" onclick="addIngredientToNewProduct()">è¿½åŠ </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAddProductModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-success" id="productModalSaveBtn" onclick="addProduct()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <script>
// ========================================
// ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
// ========================================

// è£½å“ãƒã‚¹ã‚¿ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ãã®ã‚‚ã®ï¼‰
let cookies = [
    { id: 1, name: 'ãƒãƒ‹ãƒ©ã‚¯ãƒƒã‚­ãƒ¼' },
    { id: 2, name: 'ãƒãƒ§ã‚³ã‚¯ãƒƒã‚­ãƒ¼' },
    { id: 3, name: 'ç´…èŠ‹ã‚¯ãƒƒã‚­ãƒ¼' },
    { id: 4, name: 'é»’ç³–ã‚¯ãƒƒã‚­ãƒ¼' },
    { id: 5, name: 'ãƒãƒ³ã‚´ãƒ¼ã‚¯ãƒƒã‚­ãƒ¼' }
];

// å•†å“ãƒã‚¹ã‚¿ï¼ˆè¢‹è©°ã‚è£½å“ï¼‰
// ingredients: { cookieId: quantity }
let products = [
    { 
        id: 1, 
        name: 'ãƒãƒ‹ãƒ©ã‚¯ãƒƒã‚­ãƒ¼12å€‹å…¥ã‚Š', 
        baseWeeklyDemand: 20,
        currentStock: 10,
        safetyStock: 8,
        ingredients: { 1: 12 } // ãƒãƒ‹ãƒ©ã‚¯ãƒƒã‚­ãƒ¼12å€‹
    },
    { 
        id: 2, 
        name: 'ãƒãƒ§ã‚³ã‚¯ãƒƒã‚­ãƒ¼10å€‹å…¥ã‚Š', 
        baseWeeklyDemand: 25,
        currentStock: 15,
        safetyStock: 10,
        ingredients: { 2: 10 } // ãƒãƒ§ã‚³ã‚¯ãƒƒã‚­ãƒ¼10å€‹
    },
    { 
        id: 3, 
        name: 'æ²–ç¸„è©°ã‚åˆã‚ã›15å€‹å…¥ã‚Š', 
        baseWeeklyDemand: 30,
        currentStock: 20,
        safetyStock: 12,
        ingredients: { 3: 5, 4: 5, 5: 5 } // ç´…èŠ‹5ã€é»’ç³–5ã€ãƒãƒ³ã‚´ãƒ¼5
    },
    { 
        id: 4, 
        name: 'ãƒãƒ‹ãƒ©&ãƒãƒ§ã‚³ãƒŸãƒƒã‚¯ã‚¹20å€‹å…¥ã‚Š', 
        baseWeeklyDemand: 15,
        currentStock: 8,
        safetyStock: 6,
        ingredients: { 1: 10, 2: 10 } // ãƒãƒ‹ãƒ©10ã€ãƒãƒ§ã‚³10
    }
];

// éœ€è¦äºˆæ¸¬ä¿‚æ•°
let demandFactors = { weather: 1.0, season: 1.15, event: 1.0, tourist: 1.05 };

// ã‚ªãƒ¼ãƒ–ãƒ³è¨­å®šï¼ˆé…åˆ—ã§è¤‡æ•°ç®¡ç†ï¼‰
let ovens = [
    { id: 1, name: 'ã‚ªãƒ¼ãƒ–ãƒ³1å·æ©Ÿ', piecesPerBatch: 150, workingHours: 8, batchDuration: 45 },
    { id: 2, name: 'ã‚ªãƒ¼ãƒ–ãƒ³2å·æ©Ÿ', piecesPerBatch: 150, workingHours: 8, batchDuration: 45 }
];

// ã‚ªãƒ¼ãƒ–ãƒ³IDç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
let nextOvenId = 3;

// ã‚·ãƒ•ãƒˆé‡ã¿
let shiftWeights = [1.0, 1.0, 1.0, 1.0, 1.0, 1.0];

// ç”Ÿç”£èƒ½åŠ›
let maxDailyProduction = 0;

// å¤§å£æ³¨æ–‡
let bulkOrders = [];

// æ–°è¦å•†å“ã®è£½å“ãƒªã‚¹ãƒˆï¼ˆä¸€æ™‚ä¿å­˜ï¼‰
let tempIngredients = {};

// ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç”¨
let editingProductId = null;

// IDç”Ÿæˆç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
let nextCookieId = 6;
let nextProductId = 5;

// ========================================
// åˆæœŸåŒ–
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    updateCookieList();
    updateProductList();
    initializeProductSelection();
    updateBulkOrdersList();
    updateOvensList();
    updateCapacity();
    updateAll();
});

// ========================================
// è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
// ========================================

function toggleWeeklyPlan() {
    const element = document.getElementById('weeklyPlanCollapsible');
    if (element.style.display === 'none') {
        element.style.display = 'block';
    } else {
        element.style.display = 'none';
    }
}

function toggleCookieProduction() {
    const element = document.getElementById('cookieProductionCollapsible');
    if (element.style.display === 'none') {
        element.style.display = 'block';
    } else {
        element.style.display = 'none';
    }
}

// ========================================
// ãƒã‚¹ã‚¿ç®¡ç† - è£½å“ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ï¼‰
// ========================================

function openAddCookieModal() {
    document.getElementById('newCookieName').value = '';
    document.getElementById('addCookieModal').classList.add('show');
}

function closeAddCookieModal() {
    document.getElementById('addCookieModal').classList.remove('show');
}

function addCookie() {
    const name = document.getElementById('newCookieName').value.trim();
    
    if (!name) {
        alert('è£½å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    const newCookie = {
        id: nextCookieId++,
        name: name
    };
    
    cookies.push(newCookie);
    updateCookieList();
    updateIngredientSelects();
    closeAddCookieModal();
    showNotification(`è£½å“ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`, 'success');
}

function deleteCookie(cookieId) {
    // ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const usingProducts = products.filter(p => p.ingredients[cookieId]);
    
    if (usingProducts.length > 0) {
        const productNames = usingProducts.map(p => `  â€¢ ${p.name}`).join('\n');
        alert(`âŒ ã“ã®è£½å“ã¯ä»¥ä¸‹ã®å•†å“ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚\n\nã€ä½¿ç”¨ã—ã¦ã„ã‚‹å•†å“ã€‘\n${productNames}\n\nå…ˆã«ä¸Šè¨˜ã®å•†å“ã‚’å‰Šé™¤ã¾ãŸã¯ç·¨é›†ã—ã¦ãã ã•ã„ã€‚`);
        return;
    }
    
    const cookie = cookies.find(c => c.id === cookieId);
    if (!cookie) return;
    
    if (!confirm(`ğŸ—‘ï¸ è£½å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nè£½å“å: ${cookie.name}\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
    }
    
    cookies = cookies.filter(c => c.id !== cookieId);
    updateCookieList();
    updateIngredientSelects();
    showNotification('è£½å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
}

function updateCookieList() {
    const container = document.getElementById('cookieList');
    
    if (cookies.length === 0) {
        container.innerHTML = '<p style="color: #64748b; font-style: italic;">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹è£½å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }
    
    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>è£½å“å</th>
                    <th>ä½¿ç”¨çŠ¶æ³</th>
                    <th style="width: 100px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                ${cookies.map(cookie => {
                    const usingProducts = products.filter(p => p.ingredients[cookie.id]);
                    let usageInfo;
                    
                    if (usingProducts.length > 0) {
                        const productList = usingProducts.map(p => p.name).join('ã€');
                        usageInfo = `
                            <span style="color: #059669; cursor: help;" title="${productList}">
                                âœ“ ${usingProducts.length}å•†å“ã§ä½¿ç”¨ä¸­
                            </span>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                ${usingProducts.map(p => `â€¢ ${p.name}`).join('<br>')}
                            </div>
                        `;
                    } else {
                        usageInfo = `<span style="color: #64748b;">æœªä½¿ç”¨</span>`;
                    }
                    
                    return `
                    <tr>
                        <td><strong>${cookie.name}</strong></td>
                        <td>${usageInfo}</td>
                        <td>
                            <button class="btn btn-small btn-danger" onclick="deleteCookie(${cookie.id})">å‰Šé™¤</button>
                        </td>
                    </tr>
                `}).join('')}
            </tbody>
        </table>
    `;
}

// ========================================
// ãƒã‚¹ã‚¿ç®¡ç† - å•†å“ï¼ˆè¢‹è©°ã‚è£½å“ï¼‰
// ========================================

function openAddProductModal() {
    editingProductId = null;
    document.getElementById('productModalTitle').textContent = 'æ–°è¦å•†å“ï¼ˆè¢‹è©°ã‚è£½å“ï¼‰è¿½åŠ ';
    document.getElementById('productModalSaveBtn').textContent = 'è¿½åŠ ';
    document.getElementById('productModalSaveBtn').onclick = addProduct;
    
    document.getElementById('newProductName').value = '';
    document.getElementById('newProductBaseDemand').value = '10';
    document.getElementById('newProductStock').value = '0';
    document.getElementById('newProductSafetyStock').value = '5';
    tempIngredients = {};
    updateIngredientSelects();
    updateNewProductIngredientsList();
    document.getElementById('addProductModal').classList.add('show');
}

function openEditProductModal(productId) {
    editingProductId = productId;
    const product = products.find(p => p.id === productId);
    
    if (!product) return;
    
    document.getElementById('productModalTitle').textContent = 'å•†å“ç·¨é›†';
    document.getElementById('productModalSaveBtn').textContent = 'ä¿å­˜';
    document.getElementById('productModalSaveBtn').onclick = saveEditedProduct;
    
    document.getElementById('newProductName').value = product.name;
    document.getElementById('newProductBaseDemand').value = product.baseWeeklyDemand;
    document.getElementById('newProductStock').value = product.currentStock;
    document.getElementById('newProductSafetyStock').value = product.safetyStock;
    tempIngredients = { ...product.ingredients };
    updateIngredientSelects();
    updateNewProductIngredientsList();
    document.getElementById('addProductModal').classList.add('show');
}

function closeAddProductModal() {
    editingProductId = null;
    document.getElementById('addProductModal').classList.remove('show');
}

function updateIngredientSelects() {
    const select = document.getElementById('ingredientCookieSelect');
    select.innerHTML = '<option value="">è£½å“ã‚’é¸æŠ...</option>' + 
        cookies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

function addIngredientToNewProduct() {
    const cookieId = parseInt(document.getElementById('ingredientCookieSelect').value);
    const quantity = parseInt(document.getElementById('ingredientQuantity').value);
    
    if (!cookieId || !quantity || quantity < 1) {
        alert('è£½å“ã¨å€‹æ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    tempIngredients[cookieId] = quantity;
    updateNewProductIngredientsList();
    
    document.getElementById('ingredientCookieSelect').value = '';
    document.getElementById('ingredientQuantity').value = '1';
}

function removeIngredientFromNewProduct(cookieId) {
    delete tempIngredients[cookieId];
    updateNewProductIngredientsList();
}

function updateNewProductIngredientsList() {
    const container = document.getElementById('newProductIngredients');
    
    if (Object.keys(tempIngredients).length === 0) {
        container.innerHTML = '<p style="color: #64748b; font-style: italic;">è£½å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
        return;
    }
    
    container.innerHTML = Object.keys(tempIngredients).map(cookieId => {
        const cookie = cookies.find(c => c.id == cookieId);
        const quantity = tempIngredients[cookieId];
        return `
            <div class="ingredient-item">
                <span>${cookie.name} Ã— ${quantity}å€‹</span>
                <button class="btn btn-small btn-danger" onclick="removeIngredientFromNewProduct(${cookieId})">å‰Šé™¤</button>
            </div>
        `;
    }).join('');
}

function addProduct() {
    const name = document.getElementById('newProductName').value.trim();
    const baseDemand = parseInt(document.getElementById('newProductBaseDemand').value);
    const stock = parseInt(document.getElementById('newProductStock').value);
    const safetyStock = parseInt(document.getElementById('newProductSafetyStock').value);
    
    if (!name) {
        alert('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    if (!baseDemand || baseDemand < 1) {
        alert('åŸºæº–éœ€è¦ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    if (Object.keys(tempIngredients).length === 0) {
        alert('å°‘ãªãã¨ã‚‚1ã¤ã®è£½å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    const newProduct = {
        id: nextProductId++,
        name: name,
        baseWeeklyDemand: baseDemand,
        currentStock: stock,
        safetyStock: safetyStock,
        ingredients: { ...tempIngredients }
    };
    
    products.push(newProduct);
    updateProductList();
    initializeProductSelection();
    closeAddProductModal();
    showNotification(`å•†å“ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`, 'success');
    updateAll();
}

function saveEditedProduct() {
    if (editingProductId === null) return;
    
    const product = products.find(p => p.id === editingProductId);
    if (!product) return;
    
    const name = document.getElementById('newProductName').value.trim();
    const baseDemand = parseInt(document.getElementById('newProductBaseDemand').value);
    const stock = parseInt(document.getElementById('newProductStock').value);
    const safetyStock = parseInt(document.getElementById('newProductSafetyStock').value);
    
    if (!name) {
        alert('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    if (!baseDemand || baseDemand < 1) {
        alert('åŸºæº–éœ€è¦ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    if (Object.keys(tempIngredients).length === 0) {
        alert('å°‘ãªãã¨ã‚‚1ã¤ã®è£½å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    product.name = name;
    product.baseWeeklyDemand = baseDemand;
    product.currentStock = stock;
    product.safetyStock = safetyStock;
    product.ingredients = { ...tempIngredients };
    
    updateProductList();
    initializeProductSelection();
    closeAddProductModal();
    showNotification(`å•†å“ã€Œ${name}ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`, 'success');
    updateAll();
}

function deleteProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    if (!confirm(`ğŸ—‘ï¸ å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nå•†å“å: ${product.name}\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
    }
    
    products = products.filter(p => p.id !== productId);
    updateProductList();
    initializeProductSelection();
    showNotification('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
    updateAll();
}

function updateProductList() {
    const container = document.getElementById('productList');
    
    if (products.length === 0) {
        container.innerHTML = '<p style="color: #64748b; font-style: italic;">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }
    
    container.innerHTML = products.map(product => {
        const ingredientsList = Object.keys(product.ingredients).map(cookieId => {
            const cookie = cookies.find(c => c.id == cookieId);
            return `${cookie.name} Ã— ${product.ingredients[cookieId]}å€‹`;
        }).join(', ');
        
        return `
            <div class="card">
                <div class="card-header">
                    <div class="card-title">${product.name}</div>
                    <div>
                        <button class="btn btn-small btn-warning" onclick="openEditProductModal(${product.id})">ç·¨é›†</button>
                        <button class="btn btn-small btn-danger" onclick="deleteProduct(${product.id})">å‰Šé™¤</button>
                    </div>
                </div>
                <div>
                    <p><strong>å«ã¾ã‚Œã‚‹è£½å“:</strong> ${ingredientsList}</p>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 12px;">
                        <div>
                            <label>åŸºæº–éœ€è¦ï¼ˆè¢‹/é€±ï¼‰:</label>
                            <input type="number" class="value-input-large" value="${product.baseWeeklyDemand}" 
                                   onchange="updateProductData(${product.id}, 'baseWeeklyDemand', this.value)" min="1">
                        </div>
                        <div>
                            <label>ç¾åœ¨åœ¨åº«ï¼ˆè¢‹ï¼‰:</label>
                            <input type="number" class="value-input-large" value="${product.currentStock}" 
                                   onchange="updateProductData(${product.id}, 'currentStock', this.value)" min="0">
                        </div>
                        <div>
                            <label>å®‰å…¨åœ¨åº«ï¼ˆè¢‹ï¼‰:</label>
                            <input type="number" class="value-input-large" value="${product.safetyStock}" 
                                   onchange="updateProductData(${product.id}, 'safetyStock', this.value)" min="0">
                        </div>
                        <div>
                            <label>åœ¨åº«çŠ¶æ³:</label>
                            <div class="value-input-large" style="background: ${product.currentStock < product.safetyStock ? '#fecaca' : '#dcfce7'}; color: ${product.currentStock < product.safetyStock ? '#991b1b' : '#14532d'};">
                                ${product.currentStock < product.safetyStock ? 'âš ï¸ ä¸è¶³' : 'âœ“ ååˆ†'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function updateProductData(productId, field, value) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    product[field] = parseInt(value) || 0;
    updateProductList();
    updateAll();
}

// ========================================
// å¤§å£æ³¨æ–‡ç®¡ç†
// ========================================

function initializeProductSelection() {
    const container = document.getElementById('productSelection');
    
    container.innerHTML = products.map(product => {
        const ingredientsList = Object.keys(product.ingredients).map(cookieId => {
            const cookie = cookies.find(c => c.id == cookieId);
            return `${cookie.name}Ã—${product.ingredients[cookieId]}`;
        }).join(', ');
        
        return `
            <div class="product-item">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <input type="checkbox" class="product-checkbox" id="product_${product.id}" 
                           onchange="handleProductSelection(${product.id}); updateOrderSummary();">
                    <label for="product_${product.id}" style="margin: 0; font-weight: 600;">${product.name}</label>
                </div>
                <div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">${ingredientsList}</div>
                <div>
                    <label>æ•°é‡ï¼ˆè¢‹ï¼‰:</label>
                    <input type="number" class="quantity-input" id="quantity_${product.id}" 
                           min="1" placeholder="è¢‹æ•°" onchange="updateOrderSummary();" disabled>
                </div>
                <div>
                    <label>ç´æœŸ:</label>
                    <input type="date" class="date-input" id="date_${product.id}" 
                           onchange="updateOrderSummary();" disabled>
                </div>
            </div>
        `;
    }).join('');
}

function handleProductSelection(productId) {
    const checkbox = document.getElementById(`product_${productId}`);
    const quantityInput = document.getElementById(`quantity_${productId}`);
    const dateInput = document.getElementById(`date_${productId}`);
    
    quantityInput.disabled = !checkbox.checked;
    dateInput.disabled = !checkbox.checked;
    
    if (!checkbox.checked) {
        quantityInput.value = '';
        dateInput.value = '';
    } else {
        const isSameDateMode = document.getElementById('sameDateForAll').checked;
        const commonDate = document.getElementById('commonDeliveryDate').value;
        if (isSameDateMode && commonDate) {
            dateInput.value = commonDate;
        }
    }
}

function toggleSameDateMode() {
    const isChecked = document.getElementById('sameDateForAll').checked;
    const commonDateSection = document.getElementById('commonDateInput');
    
    commonDateSection.style.display = isChecked ? 'block' : 'none';
    
    if (isChecked) {
        const commonDate = document.getElementById('commonDeliveryDate').value;
        if (commonDate) {
            applyCommonDate();
        }
    } else {
        document.getElementById('commonDeliveryDate').value = '';
        products.forEach(product => {
            const dateInput = document.getElementById(`date_${product.id}`);
            if (dateInput) dateInput.value = '';
        });
    }
    updateOrderSummary();
}

function applyCommonDate() {
    const commonDate = document.getElementById('commonDeliveryDate').value;
    
    if (commonDate) {
        products.forEach(product => {
            const checkbox = document.getElementById(`product_${product.id}`);
            const dateInput = document.getElementById(`date_${product.id}`);
            
            if (checkbox && checkbox.checked && dateInput) {
                dateInput.value = commonDate;
            }
        });
        updateOrderSummary();
    }
}

function updateOrderSummary() {
    const clientName = document.getElementById('clientName').value;
    const selectedProducts = [];
    let totalBags = 0;

    products.forEach(product => {
        const checkbox = document.getElementById(`product_${product.id}`);
        const quantityInput = document.getElementById(`quantity_${product.id}`);
        const dateInput = document.getElementById(`date_${product.id}`);
        
        if (checkbox && checkbox.checked) {
            const quantity = parseInt(quantityInput.value) || 0;
            const deliveryDate = dateInput.value;

            if (quantity > 0 && deliveryDate) {
                selectedProducts.push({
                    productId: product.id,
                    name: product.name,
                    quantity: quantity,
                    deliveryDate: deliveryDate
                });
                totalBags += quantity;
            }
        }
    });

    const summaryDiv = document.getElementById('orderSummary');
    
    if (selectedProducts.length === 0) {
        summaryDiv.innerHTML = 'å•†å“ã‚’é¸æŠã™ã‚‹ã¨å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
        return;
    }

    let summaryHtml = `
        <div style="margin-bottom: 12px;">
            <strong>ç´å“å…ˆ:</strong> ${clientName || 'æœªå…¥åŠ›'}
        </div>
        <div style="margin-bottom: 12px;">
            <strong>æ³¨æ–‡å†…å®¹:</strong>
        </div>
    `;

    selectedProducts.forEach(item => {
        const deliveryDate = new Date(item.deliveryDate);
        const today = new Date();
        const daysUntil = Math.ceil((deliveryDate - today) / (1000 * 60 * 60 * 24));
        
        summaryHtml += `
            <div style="margin-left: 16px; margin-bottom: 8px;">
                â€¢ ${item.name}: ${item.quantity}è¢‹ (ç´æœŸ: ${item.deliveryDate}, ${daysUntil}æ—¥å¾Œ)
            </div>
        `;
    });

    summaryHtml += `
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
            <strong>åˆè¨ˆ: ${totalBags}è¢‹</strong>
        </div>
    `;

    summaryDiv.innerHTML = summaryHtml;
}

function addBulkOrder() {
    const clientName = document.getElementById('clientName').value.trim();
    const note = document.getElementById('orderNote').value.trim();
    const isSameDateMode = document.getElementById('sameDateForAll').checked;
    const commonDate = document.getElementById('commonDeliveryDate').value;

    if (!clientName) {
        alert('ç´å“å…ˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    const selectedProducts = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    products.forEach(product => {
        const checkbox = document.getElementById(`product_${product.id}`);
        const quantityInput = document.getElementById(`quantity_${product.id}`);
        const dateInput = document.getElementById(`date_${product.id}`);
        
        if (checkbox && checkbox.checked) {
            const quantity = parseInt(quantityInput?.value) || 0;
            let deliveryDate = dateInput?.value || '';
            
            if (isSameDateMode) {
                deliveryDate = commonDate;
            }
            
            if (quantity > 0 && deliveryDate) {
                // éå»æ—¥ä»˜ãƒã‚§ãƒƒã‚¯
                const delivery = new Date(deliveryDate);
                delivery.setHours(0, 0, 0, 0);
                
                if (delivery < today) {
                    alert(`${product.name}ã®ç´æœŸãŒéå»ã®æ—¥ä»˜ã§ã™ã€‚ä»Šæ—¥ä»¥é™ã®æ—¥ä»˜ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }
                
                selectedProducts.push({
                    productId: product.id,
                    productName: product.name,
                    quantity: quantity,
                    deliveryDate: deliveryDate
                });
            }
        }
    });

    if (selectedProducts.length === 0) {
        alert('å°‘ãªãã¨ã‚‚1ã¤ã®å•†å“ã‚’é¸æŠã—ã€æ•°é‡ã¨ç´æœŸã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    const newBulkOrder = {
        id: Date.now(),
        clientName: clientName,
        note: note,
        products: selectedProducts,
        createdAt: new Date().toISOString().split('T')[0]
    };

    bulkOrders.push(newBulkOrder);
    clearBulkOrderForm();
    updateBulkOrdersList();
    updateAll();
    showNotification(`å¤§å£æ³¨æ–‡ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼š${clientName}`, 'success');
}

function clearBulkOrderForm() {
    document.getElementById('clientName').value = '';
    document.getElementById('orderNote').value = '';
    document.getElementById('sameDateForAll').checked = false;
    document.getElementById('commonDeliveryDate').value = '';
    toggleSameDateMode();

    products.forEach(product => {
        const checkbox = document.getElementById(`product_${product.id}`);
        const quantityInput = document.getElementById(`quantity_${product.id}`);
        const dateInput = document.getElementById(`date_${product.id}`);
        
        if (checkbox) checkbox.checked = false;
        if (quantityInput) {
            quantityInput.value = '';
            quantityInput.disabled = true;
        }
        if (dateInput) {
            dateInput.value = '';
            dateInput.disabled = true;
        }
    });
    
    updateOrderSummary();
}

function removeBulkOrder(orderId) {
    const order = bulkOrders.find(o => o.id === orderId);
    if (!order) return;
    
    const totalBags = order.products.reduce((sum, p) => sum + p.quantity, 0);
    
    if (confirm(`ğŸ—‘ï¸ å¤§å£æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nç´å“å…ˆ: ${order.clientName}\nåˆè¨ˆæ•°é‡: ${totalBags}è¢‹\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        bulkOrders = bulkOrders.filter(o => o.id !== orderId);
        updateBulkOrdersList();
        updateAll();
        showNotification('å¤§å£æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
    }
}

function updateBulkOrdersList() {
    const container = document.getElementById('bulkOrdersList');
    
    if (bulkOrders.length === 0) {
        container.innerHTML = '<p style="color: #64748b; font-style: italic;">ç™»éŒ²æ¸ˆã¿ã®å¤§å£æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }

    container.innerHTML = bulkOrders.map(order => {
        const totalBags = order.products.reduce((sum, p) => sum + p.quantity, 0);
        
        return `
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="client-name">${order.clientName}</div>
                        <div style="color: #64748b; font-size: 14px; margin-top: 4px;">
                            ç™»éŒ²æ—¥: ${order.createdAt} | åˆè¨ˆ: ${totalBags}è¢‹
                            ${order.note ? ` | å‚™è€ƒ: ${order.note}` : ''}
                        </div>
                    </div>
                    <button class="btn btn-small btn-danger" onclick="removeBulkOrder(${order.id})">å‰Šé™¤</button>
                </div>
                <div>
                    ${order.products.map(p => {
                        const today = new Date();
                        const deliveryDate = new Date(p.deliveryDate);
                        const daysUntil = Math.ceil((deliveryDate - today) / (1000 * 60 * 60 * 24));
                        return `
                            <div style="padding: 8px; border-bottom: 1px solid #f1f5f9;">
                                <strong>${p.productName}</strong>: ${p.quantity}è¢‹ (ç´æœŸ: ${p.deliveryDate}, ${daysUntil}æ—¥å¾Œ)
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }).join('');
}

// ========================================
// éœ€è¦äºˆæ¸¬
// ========================================

function updateForecast() {
    demandFactors.weather = parseFloat(document.getElementById('weather').value) || 1.0;
    demandFactors.season = parseFloat(document.getElementById('season').value) || 1.0;
    demandFactors.event = parseFloat(document.getElementById('event').value) || 1.0;
    demandFactors.tourist = parseFloat(document.getElementById('tourist').value) || 1.0;
    
    const total = demandFactors.weather * demandFactors.season * demandFactors.event * demandFactors.tourist;
    
    document.getElementById('weatherFactor').textContent = demandFactors.weather.toFixed(2);
    document.getElementById('seasonFactor').textContent = demandFactors.season.toFixed(2);
    document.getElementById('eventFactor').textContent = demandFactors.event.toFixed(2);
    document.getElementById('touristFactor').textContent = demandFactors.tourist.toFixed(2);
    document.getElementById('totalFactor').textContent = total.toFixed(2);
    
    const impact = ((total - 1) * 100).toFixed(0);
    document.getElementById('demandImpact').textContent = impact >= 0 ? `+${impact}%` : `${impact}%`;
    
    updateProductionPlan();
}

// ========================================
// ä¾›çµ¦ç®¡ç† - ã‚ªãƒ¼ãƒ–ãƒ³è¨­å®š
// ========================================

function addOven() {
    const newOven = {
        id: nextOvenId++,
        name: `ã‚ªãƒ¼ãƒ–ãƒ³${nextOvenId - 1}å·æ©Ÿ`,
        piecesPerBatch: 150,
        workingHours: 8,
        batchDuration: 45
    };
    ovens.push(newOven);
    updateOvensList();
    updateCapacity();
    showNotification(`${newOven.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`, 'success');
}

function deleteOven(ovenId) {
    if (ovens.length <= 1) {
        alert('âŒ æœ€ä½1å°ã®ã‚ªãƒ¼ãƒ–ãƒ³ãŒå¿…è¦ã§ã™ã€‚\n\nã‚ªãƒ¼ãƒ–ãƒ³ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ã€ä»–ã®ã‚ªãƒ¼ãƒ–ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    const oven = ovens.find(o => o.id === ovenId);
    if (!oven) return;
    
    if (confirm(`ğŸ—‘ï¸ ã‚ªãƒ¼ãƒ–ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã‚ªãƒ¼ãƒ–ãƒ³å: ${oven.name}\nç„¼æˆèƒ½åŠ›: ${oven.piecesPerBatch}å€‹/å›\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        ovens = ovens.filter(o => o.id !== ovenId);
        updateOvensList();
        updateCapacity();
        showNotification('ã‚ªãƒ¼ãƒ–ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
    }
}

function updateOvenData(ovenId, field, value) {
    const oven = ovens.find(o => o.id === ovenId);
    if (!oven) return;
    
    if (field === 'name') {
        oven.name = value;
    } else {
        oven[field] = parseInt(value) || 0;
    }
    
    updateOvensList();
    updateCapacity();
}

function updateOvensList() {
    const container = document.getElementById('ovensList');
    
    if (ovens.length === 0) {
        container.innerHTML = '<p style="color: #64748b; font-style: italic;">ã‚ªãƒ¼ãƒ–ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
        return;
    }
    
    container.innerHTML = ovens.map(oven => {
        const minutesPerDay = oven.workingHours * 60;
        const batchesPerDay = Math.floor(minutesPerDay / oven.batchDuration);
        const dailyCapacity = batchesPerDay * oven.piecesPerBatch;
        
        return `
            <div class="oven-card">
                <div class="oven-card-header">
                    <input type="text" class="oven-name-input" value="${oven.name}" 
                           onchange="updateOvenData(${oven.id}, 'name', this.value)">
                    <button class="btn btn-small btn-danger" onclick="deleteOven(${oven.id})">å‰Šé™¤</button>
                </div>
                <div class="oven-settings-grid">
                    <div class="form-group">
                        <label>1å›ç„¼æˆå€‹æ•°:</label>
                        <input type="number" value="${oven.piecesPerBatch}" min="10" step="10"
                               onchange="updateOvenData(${oven.id}, 'piecesPerBatch', this.value)">
                    </div>
                    <div class="form-group">
                        <label>ç¨¼åƒæ™‚é–“/æ—¥:</label>
                        <input type="number" value="${oven.workingHours}" min="1" max="24"
                               onchange="updateOvenData(${oven.id}, 'workingHours', this.value)">
                    </div>
                    <div class="form-group">
                        <label>ç„¼æˆæ™‚é–“(åˆ†):</label>
                        <input type="number" value="${oven.batchDuration}" min="10" step="5"
                               onchange="updateOvenData(${oven.id}, 'batchDuration', this.value)">
                    </div>
                </div>
                <div class="oven-capacity">
                    <strong>ã“ã®ã‚ªãƒ¼ãƒ–ãƒ³ã®èƒ½åŠ›:</strong> ${batchesPerDay}å›/æ—¥ Ã— ${oven.piecesPerBatch}å€‹ = ${dailyCapacity}å€‹/æ—¥
                </div>
            </div>
        `;
    }).join('');
}

function updateCapacity() {
    let totalBatches = 0;
    let totalCapacity = 0;
    
    ovens.forEach(oven => {
        const minutesPerDay = oven.workingHours * 60;
        const batchesPerDay = Math.floor(minutesPerDay / oven.batchDuration);
        const dailyCapacity = batchesPerDay * oven.piecesPerBatch;
        
        totalBatches += batchesPerDay;
        totalCapacity += dailyCapacity;
    });
    
    maxDailyProduction = totalCapacity;
    
    document.getElementById('totalMaxBatches').textContent = totalBatches;
    document.getElementById('totalMaxCapacity').textContent = totalCapacity;
}

// ========================================
// ä¾›çµ¦ç®¡ç† - ã‚·ãƒ•ãƒˆè¨­å®š
// ========================================

function updateShiftWeight(dayIndex, weight) {
    shiftWeights[dayIndex] = parseFloat(weight) || 1.0;
}

function setShiftPreset(presetType) {
    switch(presetType) {
        case 'normal':
            shiftWeights = [1.0, 1.0, 1.0, 1.0, 1.0, 1.0];
            break;
        case 'weekend':
            shiftWeights = [1.0, 1.0, 1.0, 1.0, 1.5, 1.5];
            break;
        case 'midweek':
            shiftWeights = [1.0, 1.3, 1.3, 1.3, 1.0, 1.0];
            break;
    }
    
    document.getElementById('mondayWeight').value = shiftWeights[0];
    document.getElementById('tuesdayWeight').value = shiftWeights[1];
    document.getElementById('wednesdayWeight').value = shiftWeights[2];
    document.getElementById('thursdayWeight').value = shiftWeights[3];
    document.getElementById('fridayWeight').value = shiftWeights[4];
    document.getElementById('saturdayWeight').value = shiftWeights[5];
}

// ========================================
// ç”Ÿç”£è¨ˆç”»
// ========================================

function getWeeklyBulkOrders() {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ
    const weekEnd = new Date(today);
    weekEnd.setDate(today.getDate() + 6);
    weekEnd.setHours(23, 59, 59, 999); // é€±æœ«ã®çµ‚ã‚ã‚Šã¾ã§
    
    const weeklyOrders = {};
    
    bulkOrders.forEach(order => {
        order.products.forEach(p => {
            const deliveryDate = new Date(p.deliveryDate);
            deliveryDate.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ
            
            if (deliveryDate >= today && deliveryDate <= weekEnd) {
                if (!weeklyOrders[p.productId]) {
                    weeklyOrders[p.productId] = 0;
                }
                weeklyOrders[p.productId] += p.quantity;
            }
        });
    });
    
    console.log('é€±æ¬¡å¤§å£æ³¨æ–‡:', weeklyOrders); // ãƒ‡ãƒãƒƒã‚°ç”¨
    return weeklyOrders;
}

function updateProductionPlan() {
    const totalFactor = demandFactors.weather * demandFactors.season * demandFactors.event * demandFactors.tourist;
    const weeklyBulkOrders = getWeeklyBulkOrders();
    
    const weeklyPlan = products.map(product => {
        const forecast = Math.round(product.baseWeeklyDemand * totalFactor);
        const bulkOrderQuantity = weeklyBulkOrders[product.id] || 0;
        const totalDemand = forecast + bulkOrderQuantity;
        
        const targetStock = totalDemand + product.safetyStock;
        const production = Math.max(0, targetStock - product.currentStock);
        const expectedStock = product.currentStock + production - totalDemand;
        
        return {
            id: product.id,
            name: product.name,
            currentStock: product.currentStock,
            baseDemand: product.baseWeeklyDemand,
            forecast: forecast,
            bulkOrder: bulkOrderQuantity,
            totalDemand: totalDemand,
            production: production,
            expectedStock: expectedStock,
            safetyStock: product.safetyStock,
            ingredients: product.ingredients
        };
    });
    
    const tbody = document.getElementById('planTableBody');
    tbody.innerHTML = weeklyPlan.map(plan => {
        let stockClass = '';
        if (plan.currentStock < plan.safetyStock) {
            stockClass = 'style="background-color: #fecaca; color: #991b1b; font-weight: 700;"';
        }
        
        let productionClass = '';
        if (plan.production > 0) {
            productionClass = 'style="background-color: #fef3c7; color: #92400e; font-weight: 600;"';
        }
        
        return `
            <tr>
                <td>${plan.name}</td>
                <td ${stockClass}>${plan.currentStock}è¢‹</td>
                <td>${plan.baseDemand}è¢‹</td>
                <td>${plan.forecast}è¢‹</td>
                <td ${plan.bulkOrder > 0 ? 'style="background-color: #fef3c7; font-weight: 600;"' : ''}>${plan.bulkOrder}è¢‹</td>
                <td><strong>${plan.totalDemand}è¢‹</strong></td>
                <td ${productionClass}>${plan.production}è¢‹</td>
                <td>${plan.expectedStock}è¢‹</td>
            </tr>
        `;
    }).join('');
    
    updateCookieProductionPlan(weeklyPlan);
    updateTodayProduction(weeklyPlan);
}

function updateCookieProductionPlan(weeklyPlan) {
    const cookieProduction = {};
    
    weeklyPlan.forEach(plan => {
        if (plan.production > 0) {
            Object.keys(plan.ingredients).forEach(cookieId => {
                const quantity = plan.ingredients[cookieId] * plan.production;
                if (!cookieProduction[cookieId]) {
                    cookieProduction[cookieId] = {
                        total: 0,
                        breakdown: []
                    };
                }
                cookieProduction[cookieId].total += quantity;
                cookieProduction[cookieId].breakdown.push({
                    productName: plan.name,
                    bags: plan.production,
                    cookies: quantity
                });
            });
        }
    });
    
    const tbody = document.getElementById('cookieProductionTableBody');
    
    if (Object.keys(cookieProduction).length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" style="text-align: center; color: #64748b; font-style: italic;">
                    ä»Šé€±ã¯ç”Ÿç”£äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = Object.keys(cookieProduction).map(cookieId => {
        const cookie = cookies.find(c => c.id == cookieId);
        const data = cookieProduction[cookieId];
        
        const breakdownText = data.breakdown.map(b => 
            `${b.productName} ${b.bags}è¢‹åˆ†ï¼ˆ${b.cookies}å€‹ï¼‰`
        ).join('ã€');
        
        return `
            <tr>
                <td><strong>${cookie.name}</strong></td>
                <td style="font-size: 20px; font-weight: 700; color: #475569;">${data.total}å€‹</td>
                <td style="font-size: 14px; color: #64748b;">${breakdownText}</td>
            </tr>
        `;
    }).join('');
}

function updateTodayProduction(weeklyPlan) {
    const cookieProduction = {};
    
    weeklyPlan.forEach(plan => {
        if (plan.production > 0) {
            Object.keys(plan.ingredients).forEach(cookieId => {
                const quantity = plan.ingredients[cookieId] * plan.production;
                if (!cookieProduction[cookieId]) {
                    cookieProduction[cookieId] = 0;
                }
                cookieProduction[cookieId] += quantity;
            });
        }
    });
    
    const container = document.getElementById('todayProduction');
    
    if (Object.keys(cookieProduction).length === 0) {
        container.innerHTML = `
            <div class="status-card">
                <div class="status-number">âœ…</div>
                <div class="status-label">ä»Šæ—¥ã®ç”Ÿç”£äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        `;
        return;
    }
    
    // 6æ—¥ã§å‡ç­‰é…åˆ†ï¼ˆä»Šæ—¥åˆ†ã¯1/6ï¼‰
    container.innerHTML = Object.keys(cookieProduction).map(cookieId => {
        const cookie = cookies.find(c => c.id == cookieId);
        const totalWeekly = cookieProduction[cookieId];
        const dailyAmount = Math.round(totalWeekly / 6);
        
        return `
            <div class="status-card">
                <div class="status-number">${dailyAmount}å€‹</div>
                <div class="status-label">
                    ${cookie.name}<br>
                    <small>é€±é–“: ${totalWeekly}å€‹</small>
                </div>
            </div>
        `;
    }).join('');
}

// ========================================
// æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
// ========================================

function toggleCollapsible(id) {
    const content = document.getElementById(id + '-content');
    const icon = document.getElementById(id + '-icon');
    
    if (content.classList.contains('open')) {
        content.classList.remove('open');
        icon.classList.remove('rotated');
    } else {
        content.classList.add('open');
        icon.classList.add('rotated');
    }
}

// ========================================
// å…¨ä½“æ›´æ–°
// ========================================

function updateAll() {
    updateForecast();
    showNotification('è¨ˆç”»ã‚’å†è¨ˆç®—ã—ã¾ã—ãŸã€‚', 'success');
}

// ========================================
// ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­è¾¼
// ========================================

function exportAllData() {
    const data = {
        version: 2.1,
        cookies: cookies,
        products: products,
        demandFactors: demandFactors,
        ovens: ovens,
        shiftWeights: shiftWeights,
        bulkOrders: bulkOrders,
        nextCookieId: nextCookieId,
        nextProductId: nextProductId,
        nextOvenId: nextOvenId
    };
    
    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    const filename = `ishigaki_cookie_data_v2_1_${new Date().toISOString().split('T')[0]}.json`;
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification(`${filename} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`, 'success');
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³2.1ï¼ˆã‚ªãƒ¼ãƒ–ãƒ³é…åˆ—å¯¾å¿œï¼‰
            if (data.version === 2.1) {
                cookies = data.cookies || [];
                products = data.products || [];
                demandFactors = data.demandFactors || { weather: 1.0, season: 1.15, event: 1.0, tourist: 1.05 };
                ovens = data.ovens || [{ id: 1, name: 'ã‚ªãƒ¼ãƒ–ãƒ³1å·æ©Ÿ', piecesPerBatch: 150, workingHours: 8, batchDuration: 45 }];
                shiftWeights = data.shiftWeights || [1.0, 1.0, 1.0, 1.0, 1.0, 1.0];
                bulkOrders = data.bulkOrders || [];
                nextCookieId = data.nextCookieId || 1;
                nextProductId = data.nextProductId || 1;
                nextOvenId = data.nextOvenId || 1;
                
                // ã‚·ãƒ•ãƒˆè¨­å®šã®UIæ›´æ–°
                document.getElementById('mondayWeight').value = shiftWeights[0];
                document.getElementById('tuesdayWeight').value = shiftWeights[1];
                document.getElementById('wednesdayWeight').value = shiftWeights[2];
                document.getElementById('thursdayWeight').value = shiftWeights[3];
                document.getElementById('fridayWeight').value = shiftWeights[4];
                document.getElementById('saturdayWeight').value = shiftWeights[5];
            }
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³2.0ï¼ˆæ—§å½¢å¼ï¼‰ã®äº’æ›æ€§å¯¾å¿œ
            else if (data.version === 2) {
                cookies = data.cookies || [];
                products = data.products || [];
                demandFactors = data.demandFactors || { weather: 1.0, season: 1.15, event: 1.0, tourist: 1.05 };
                bulkOrders = data.bulkOrders || [];
                nextCookieId = data.nextCookieId || 1;
                nextProductId = data.nextProductId || 1;
                
                // æ—§å½¢å¼ã®ã‚ªãƒ¼ãƒ–ãƒ³è¨­å®šã‚’é…åˆ—ã«å¤‰æ›
                if (data.ovenSettings) {
                    ovens = [];
                    for (let i = 0; i < data.ovenSettings.ovenCount; i++) {
                        ovens.push({
                            id: i + 1,
                            name: `ã‚ªãƒ¼ãƒ–ãƒ³${i + 1}å·æ©Ÿ`,
                            piecesPerBatch: data.ovenSettings.piecesPerBatch,
                            workingHours: data.ovenSettings.workingHours,
                            batchDuration: data.ovenSettings.batchDuration
                        });
                    }
                    nextOvenId = data.ovenSettings.ovenCount + 1;
                } else {
                    ovens = [{ id: 1, name: 'ã‚ªãƒ¼ãƒ–ãƒ³1å·æ©Ÿ', piecesPerBatch: 150, workingHours: 8, batchDuration: 45 }];
                    nextOvenId = 2;
                }
                
                shiftWeights = data.shiftWeights || [1.0, 1.0, 1.0, 1.0, 1.0, 1.0];
                
                // ã‚·ãƒ•ãƒˆè¨­å®šã®UIæ›´æ–°
                document.getElementById('mondayWeight').value = shiftWeights[0];
                document.getElementById('tuesdayWeight').value = shiftWeights[1];
                document.getElementById('wednesdayWeight').value = shiftWeights[2];
                document.getElementById('thursdayWeight').value = shiftWeights[3];
                document.getElementById('fridayWeight').value = shiftWeights[4];
                document.getElementById('saturdayWeight').value = shiftWeights[5];
            } else {
                alert('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™ã€‚');
                return;
            }
            
            updateCookieList();
            updateProductList();
            initializeProductSelection();
            updateBulkOrdersList();
            updateOvensList();
            updateCapacity();
            updateAll();
            
            showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚', 'success');
        } catch (error) {
            console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
    };
    reader.readAsText(file, 'UTF-8');
}

// ========================================
// é€šçŸ¥æ©Ÿèƒ½
// ========================================

function showNotification(message, type = 'info') {
    const existingNotification = document.getElementById('notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.id = 'notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    switch (type) {
        case 'success':
            notification.style.backgroundColor = '#14532d';
            break;
        case 'error':
            notification.style.backgroundColor = '#991b1b';
            break;
        case 'warning':
            notification.style.backgroundColor = '#a16207';
            break;
        default:
            notification.style.backgroundColor = '#475569';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

    </script>
</body>
</html>
